"use strict";(()=>{var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod));var require_cjs=__commonJS({"node_modules/.pnpm/deepmerge@4.3.1/node_modules/deepmerge/dist/cjs.js"(exports,module){"use strict";var isMergeableObject=function(value){return isNonNullObject(value)&&!isSpecial(value)};function isNonNullObject(value){return!!value&&typeof value=="object"}function isSpecial(value){var stringValue=Object.prototype.toString.call(value);return stringValue==="[object RegExp]"||stringValue==="[object Date]"||isReactElement(value)}var canUseSymbol=typeof Symbol=="function"&&Symbol.for,REACT_ELEMENT_TYPE=canUseSymbol?Symbol.for("react.element"):60103;function isReactElement(value){return value.$$typeof===REACT_ELEMENT_TYPE}function emptyTarget(val){return Array.isArray(val)?[]:{}}function cloneUnlessOtherwiseSpecified(value,options){return options.clone!==!1&&options.isMergeableObject(value)?deepmerge(emptyTarget(value),value,options):value}function defaultArrayMerge(target,source,options){return target.concat(source).map(function(element){return cloneUnlessOtherwiseSpecified(element,options)})}function getMergeFunction(key,options){if(!options.customMerge)return deepmerge;var customMerge=options.customMerge(key);return typeof customMerge=="function"?customMerge:deepmerge}function getEnumerableOwnPropertySymbols(target){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(target).filter(function(symbol){return Object.propertyIsEnumerable.call(target,symbol)}):[]}function getKeys(target){return Object.keys(target).concat(getEnumerableOwnPropertySymbols(target))}function propertyIsOnObject(object,property){try{return property in object}catch{return!1}}function propertyIsUnsafe(target,key){return propertyIsOnObject(target,key)&&!(Object.hasOwnProperty.call(target,key)&&Object.propertyIsEnumerable.call(target,key))}function mergeObject(target,source,options){var destination={};return options.isMergeableObject(target)&&getKeys(target).forEach(function(key){destination[key]=cloneUnlessOtherwiseSpecified(target[key],options)}),getKeys(source).forEach(function(key){propertyIsUnsafe(target,key)||(propertyIsOnObject(target,key)&&options.isMergeableObject(source[key])?destination[key]=getMergeFunction(key,options)(target[key],source[key],options):destination[key]=cloneUnlessOtherwiseSpecified(source[key],options))}),destination}function deepmerge(target,source,options){options=options||{},options.arrayMerge=options.arrayMerge||defaultArrayMerge,options.isMergeableObject=options.isMergeableObject||isMergeableObject,options.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified;var sourceIsArray=Array.isArray(source),targetIsArray=Array.isArray(target),sourceAndTargetTypesMatch=sourceIsArray===targetIsArray;return sourceAndTargetTypesMatch?sourceIsArray?options.arrayMerge(target,source,options):mergeObject(target,source,options):cloneUnlessOtherwiseSpecified(source,options)}deepmerge.all=function(array,options){if(!Array.isArray(array))throw new Error("first argument should be an array");return array.reduce(function(prev,next){return deepmerge(prev,next,options)},{})};var deepmerge_1=deepmerge;module.exports=deepmerge_1}});function parse(str){try{return JSON.parse(str)}catch{return null}}var langs_default={en:"English",fr:"Fran\xE7ais",sk:"Slovensk\xFD",sv:"Svenska",pl:"Polski",pt_BR:"Portugu\xEAs (Brasil)",nl:"Nederlandse",ru:"\u0420\u0443\u0441\u0441\u043A\u0438\u0439",zh_CN:"\u7B80\u4F53\u4E2D\u6587",zh_HK:"\u7E41\u9AD4\u4E2D\u6587",de:"Deutsch",it:"Italiano",es_ES:"Espa\xF1ol",tr:"T\xFCrk\xE7e",uk:"\u0423\u043A\u0440\u0430\u0457\u043D\u0441\u044C\u043A\u0430",id:"Indonesia",da:"Dansk",fi:"Suomi",hu:"Magyar",sr:"\u0421\u0440\u043F\u0441\u043A\u0438 (\u045B\u0438\u0440\u0438\u043B\u0438\u0446\u0430)",sr_YU:"Srpski (latinica)",gr:"\u0395\u03BB\u03BB\u03B7\u03BD\u03B9\u03BA\u03AC"};var mobilecheck=()=>navigator.userAgentData?navigator.userAgentData.mobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),stringMaxSize=(str="",size)=>str.length>size?str.slice(0,size):str,minutator=date=>date.getHours()*60+date.getMinutes(),randomString=len=>{let chars="abcdefghijklmnopqr";return Array.from({length:len},()=>chars[Math.floor(Math.random()*chars.length)]).join("")};function detectPlatform(){let p=window.location.protocol;return p==="moz-extension:"?"firefox":p==="chrome-extension:"?"chrome":p==="safari-web-extension:"?"safari":"online"}var getBrowser=(agent=window.navigator.userAgent.toLowerCase())=>agent.indexOf("edg/")>-1?"edge":agent.indexOf("chrome")>-1?"chrome":agent.indexOf("firefox")>-1?"firefox":agent.indexOf("safari")>-1?"safari":"other";function periodOfDay(sunTime2,time){let{rise,set:set2,now}=sunTime2;return time?time=minutator(new Date(time)):time=now,time>=0&&time<=rise-60?"night":time<=rise+60?"noon":time<=set2-60?"day":time<=set2+60?"evening":time>=set2+60?"night":"day"}function convertHideStorage(old){if(!Array.isArray(old))return old;let hide={};return old[0][0]&&(hide.clock=!0),old[0][1]&&(hide.date=!0),old[1][0]&&(hide.greetings=!0),old[1][1]&&(hide.weatherdesc=!0),old[1][2]&&(hide.weathericon=!0),old[3][0]&&(hide.settingsicon=!0),hide}function bundleLinks(data){let res=[];return Object.entries(data).map(([key,val])=>{key.length===11&&key.startsWith("links")&&res.push(val)}),res.sort((a,b)=>a.order-b.order),res}var inputThrottle=(elem,time=800)=>{let isThrottled=!0;setTimeout(()=>{isThrottled=!1,elem.removeAttribute("disabled")},time),isThrottled&&elem.setAttribute("disabled","")};function turnRefreshButton(button,canTurn){let animationOptions={duration:600,easing:"ease-out"};button.animate(canTurn?[{transform:"rotate(360deg)"}]:[{transform:"rotate(0deg)"},{transform:"rotate(90deg)"},{transform:"rotate(0deg)"}],animationOptions)}function closeEditLink(){let domedit=document.querySelector("#editlink");domedit&&(domedit?.classList.add("hiding"),document.querySelectorAll("#linkblocks img").forEach(img=>img?.classList.remove("selected")),setTimeout(()=>{domedit&&domedit.setAttribute("class","")},200))}var testOS={mac:window.navigator.appVersion.includes("Macintosh"),windows:window.navigator.appVersion.includes("Windows"),android:window.navigator.userAgent.includes("Android"),ios:["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document},defaultLang="en",navLang=navigator.language.replace("-","_");for(let[code]of Object.entries(langs_default))(navLang===code||navLang.startsWith(code.substring(0,2)))&&(defaultLang=code);var syncDefaults={about:{browser:detectPlatform(),version:"1.17.0"},showall:!1,lang:defaultLang,dark:"system",favicon:"",tabtitle:"",greeting:"",pagegap:1,pagewidth:1600,time:!0,main:!0,usdate:!1,background_blur:15,background_bright:.8,background_type:"unsplash",quicklinks:!0,linkstyle:"large",linknewtab:!1,linksrow:6,textShadow:.2,reviewPopup:0,cssHeight:80,css:"",hide:{},clock:{ampm:!1,analog:!1,seconds:!1,face:"none",style:"round",timezone:"auto"},unsplash:{every:"hour",collection:"",lastCollec:"day",time:Date.now()},weather:{ccode:"FR",city:"Paris",unit:"metric",location:[],provider:"",moreinfo:"none",forecast:"auto",temperature:"actual"},notes:{on:!1,width:40,text:null,opacity:.1,align:"left"},searchbar:{on:!1,opacity:.1,newtab:!1,engine:"google",request:"",placeholder:""},quotes:{on:!1,author:!1,type:"classic",frequency:"day",last:1650516688,userlist:[]},font:{url:"",family:"",size:"14",availWeights:[],weight:testOS.windows?"400":"300"},move:{selection:"single",layouts:{single:{grid:[["time"],["main"],["quicklinks"]],items:{}},double:{grid:[["time","."],["main","."],["quicklinks","."]],items:{}},triple:{grid:[[".","time","."],[".","main","."],[".","quicklinks","."]],items:{}}}}},localDefaults={waitingForPreload:!1,userQuoteSelection:0,selectedId:"",idsList:[],quotesCache:[],unsplashCache:{noon:[],day:[],evening:[],night:[],user:[]}};function verifyDataAsSync(data){data=data??{};for(let key in syncDefaults)!(key in data)&&key!=="move"&&(data[key]=syncDefaults[key]);return data}function onlineSet(props){let data=onlineGet();if(typeof props=="object"){Object.entries(props).forEach(([key,val])=>{data[key]=val});try{localStorage.bonjourr=JSON.stringify(data??{})}catch(error){console.warn(error,"Bonjourr couldn't save this setting \u{1F605} - Memory might be full")}window.dispatchEvent(new Event("storage"))}}function onlineGet(_){return verifyDataAsSync(parse(localStorage.bonjourr)??{})}function onlineRemove(key){let data=onlineGet();delete data[key],localStorage.bonjourr=JSON.stringify(data??{})}function onlineClear(){localStorage.removeItem("bonjourr")}async function getChromeStorage(key){let res=await new Promise(resolve=>{window.location.protocol==="moz-extension:"?browser.storage.sync.get(key??null).then(resolve):chrome.storage.sync.get(key??null).then(resolve)});return verifyDataAsSync(res)}var storage_default=detectPlatform()==="online"?{get:onlineGet,set:onlineSet,remove:onlineRemove,clear:onlineClear}:{get:getChromeStorage,set:(val,callback=()=>{})=>chrome.storage.sync.set(val,callback),remove:key=>chrome.storage.sync.remove(key),clear:()=>chrome.storage.sync.clear()};var trns={};async function setTranslationCache(lang){if(lang==="en"){localStorage.removeItem("translations"),trns={};return}trns=parse(localStorage.translations)??{},trns?.lang!==lang&&(localStorage.translations=await(await fetch(`../../../_locales/${lang}/translations.json`)).text(),trns=parse(localStorage.translations)??{})}function traduction(settingsDom,lang="en"){if(lang==="en")return;let tags=(settingsDom||document.body).querySelectorAll(".trn"),text;for(let tag of tags)text=tag.textContent??"",tag.textContent=trns[text]??text;document.documentElement.setAttribute("lang",lang)}async function toggleTraduction(lang){let tags=document.querySelectorAll(".trn"),newDict={},toggleDict={},currentDict={...trns},text;await setTranslationCache(lang),newDict=parse(localStorage.translations)??{},currentDict?.lang===void 0&&Object.keys(newDict).forEach(key=>currentDict[key]=key);for(let[key,val]of Object.entries(currentDict))toggleDict[val]=lang==="en"?key:newDict[key];for(let tag of tags)text=tag.textContent??"",tag.textContent=toggleDict[text]??text}function tradThis(str){return trns[str]??str}async function errorMessage(error){let dominterface4=document.getElementById("interface");console.error(error);function reduceErrorStack(){try{let lines=(error.stack||"").split(`
`);return lines.forEach((line,i)=>{let start=line.indexOf(" ("),end=line.indexOf("main.js");start>0&&end>0&&(lines[i]=line.replace(line.substring(start+1,end),"").replace(")",""))}),lines.join(`
`)}catch{return"No error stack found"}}function displayMessage(dataStr){let warning=document.createElement("div"),title=document.createElement("h1"),subtitle=document.createElement("p"),errorpre=document.createElement("pre"),storagetext=document.createElement("textarea"),explain=document.createElement("p"),resetButton=document.createElement("button"),closeError=document.createElement("button"),buttonWrap=document.createElement("div");title.textContent="Oops Bonjourr failed \u{1F616}",subtitle.textContent="Copy the error and your settings below and contact us !",explain.textContent="Sharing your settings with us helps a lot in debugging. You can also reset Bonjourr, or close this window for now if you think it is a false alert.",explain.className="error-explain",errorpre.textContent=reduceErrorStack(),storagetext.textContent=dataStr,storagetext.setAttribute("spellcheck","false"),resetButton.textContent="Reset Bonjourr",resetButton.addEventListener("click",()=>{warning.style.opacity="0",storage_default.clear(),localStorage.clear()}),closeError.className="error-buttons-close",closeError.textContent="Close this window",closeError.addEventListener("click",()=>{sessionStorage.errorMessage="removed",warning.style.opacity="0",setTimeout(()=>warning.style.display="none",400)}),buttonWrap.className="error-buttons",buttonWrap.appendChild(resetButton),buttonWrap.appendChild(closeError),warning.appendChild(title),warning.appendChild(subtitle),warning.appendChild(errorpre),warning.appendChild(storagetext),warning.appendChild(explain),warning.appendChild(buttonWrap),warning.id="error",document.body.prepend(warning),dominterface4&&(dominterface4.style.opacity="1"),setTimeout(()=>warning.style.opacity="1",20)}if(sessionStorage.errorMessage==="removed"&&dominterface4)return dominterface4.style.opacity="1",!1;try{let data=await storage_default.get();document.querySelector("#error")?.remove(),displayMessage(JSON.stringify(data,null,4))}catch{displayMessage("")}}var months=["January","February","March","April","May","June","July","August","September","October","November","December"],days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],lazyClockInterval;function zonedDate(timezone="auto"){let date=new Date;if(timezone==="auto")return date;let offset=date.getTimezoneOffset()/60,utcHour=date.getHours()+offset,utcMinutes=date.getMinutes()+date.getTimezoneOffset(),minutes;return timezone.split(".")[1]?(minutes=utcMinutes+parseInt(timezone.split(".")[1]),minutes>-30&&utcHour++):minutes=date.getMinutes(),date.setHours(utcHour+parseInt(timezone),minutes),date}function clockDate(date,usdate){let datedom=document.getElementById("date"),jour=tradThis(days[date.getDay()]),mois=tradThis(months[date.getMonth()]),chiffre=date.getDate();datedom.textContent=usdate?`${jour}, ${mois} ${chiffre}`:`${jour} ${chiffre} ${mois}`}function greetings(date,name){let rand=Math.random()>.8?1:0,hour=date.getHours(),greet="Good evening";hour<3?greet="Good evening":hour<5?greet=["Good night","Sweet dreams"][rand]:hour<12?greet="Good morning":hour<18&&(greet="Good afternoon");let domgreetings=document.getElementById("greetings");domgreetings.style.textTransform=name?"none":"capitalize",domgreetings.textContent=tradThis(greet)+(name?`, ${name}`:"")}function changeAnalogFace(face="none"){let chars={none:["","","",""],number:["12","3","6","9"],roman:["XII","III","VI","IX"],marks:["\u2502","\u2500","\u2502","\u2500"]};document.querySelectorAll("#analogClock .numbers").forEach((mark,i)=>mark.textContent=chars[face][i])}function changeAnalogStyle(style){document.getElementById("analogClock")?.setAttribute("class",style||"")}function startClock(clock2,greeting,usdate){function display2(){document.getElementById("time-container")?.classList.toggle("analog",clock2.analog),document.getElementById("analogSeconds")?.classList.toggle("hidden",!clock2.seconds)}function clockInterval(){function numerical(date2){let fixunits=val=>(val<10?"0":"")+val.toString(),h=clock2.ampm?date2.getHours()%12:date2.getHours(),m=fixunits(date2.getMinutes()),s=fixunits(date2.getSeconds());clock2.ampm&&h===0&&(h=12);let domclock=document.getElementById("clock");domclock&&(domclock?.classList.toggle("zero",!clock2.ampm&&h<10),domclock.textContent=`${h}:${m}${clock2.seconds?":"+s:""}`)}function analog(date2){let rotation=(elem,val)=>{elem&&(elem.style.transform=`rotate(${val}deg)`)},s=date2.getSeconds()*6,m=(date2.getMinutes()+date2.getSeconds()/60)*6,h=(date2.getHours()%12+date2.getMinutes()/60)*30;rotation(document.getElementById("hours"),h),rotation(document.getElementById("minutes"),m),clock2.seconds&&rotation(document.getElementById("analogSeconds"),s)}let date=zonedDate(clock2.timezone);clock2.analog?analog(date):numerical(date),date.getHours()===0&&date.getMinutes()===0&&clockDate(date,usdate),date.getMinutes()===0&&greetings(date,greeting)}lazyClockInterval&&clearInterval(lazyClockInterval),display2(),clockInterval(),lazyClockInterval=setInterval(clockInterval,1e3)}async function clockUpdate({ampm,analog,seconds,usdate,greeting,timezone,style,face}){let data=await storage_default.get(["clock","usdate","greeting"]),clock2=data?.clock;!clock2||data.usdate===void 0||data.greeting===void 0||(usdate!==void 0&&(clockDate(zonedDate(clock2.timezone),usdate),storage_default.set({usdate})),greeting!==void 0&&(greetings(zonedDate(clock2.timezone),greeting),storage_default.set({greeting})),timezone!==void 0&&(clockDate(zonedDate(timezone),data.usdate),greetings(zonedDate(timezone),greeting)),clock2={...clock2,ampm:ampm??clock2.ampm,face:face??clock2.face,style:style??clock2.style,analog:analog??clock2.analog,seconds:seconds??clock2.seconds,timezone:timezone??clock2.timezone},storage_default.set({clock:clock2}),startClock(clock2,data.greeting,data.usdate),changeAnalogFace(clock2.face),changeAnalogStyle(clock2.style))}function clock(init,event){if(event){clockUpdate(event);return}let clock2=init?.clock??{...syncDefaults.clock};try{startClock(clock2,init?.greeting||"",init?.usdate||!1),clockDate(zonedDate(clock2.timezone),init?.usdate||!1),greetings(zonedDate(clock2.timezone),init?.greeting||""),changeAnalogFace(clock2.face),changeAnalogStyle(clock2.style),canDisplayInterface("clock")}catch(e){errorMessage(e)}}function debounce(callback,waitFor){let timeout,debounced=(...args)=>{clearTimeout(timeout),timeout=setTimeout(()=>callback(...args),waitFor)};return debounced.cancel=()=>clearTimeout(timeout),debounced}var eventDebounce=debounce(function(value){storage_default.set(value)},400);var pocketEditorContainer;function setContainer(elem){return pocketEditorContainer=elem,elem}function getContainer(){return pocketEditorContainer??document.getElementById("pocket-editor")}function getLines(container=getContainer()){return Object.values(container.querySelectorAll(".line"))}function getSelectedLines(lines=getLines()){var _a;return(_a=Object.values(lines).filter(line=>line.classList.contains("sel")))!==null&&_a!==void 0?_a:[]}function getPrevLine(line,lines=getLines()){return lines[lines.indexOf(line)-1]}function getNextLine(line,lines=getLines()){return lines[lines.indexOf(line)+1]}function getLineFromEditable(elem){for(;elem?.parentElement;){if(elem.parentElement.classList.contains("line"))return elem.parentElement;elem=elem.parentElement}return null}function toHeading(editable,tag,focus){var _a;let heading=document.createElement(tag),line=getLineFromEditable(editable),mod=tag==="h1"?"#":tag==="h2"?"##":"###";heading.textContent=((_a=editable.textContent)===null||_a===void 0?void 0:_a.replace(mod,"").trimStart())||"",heading.setAttribute("contenteditable","true"),line&&(line.className="line "+tag,editable.replaceWith(heading)),focus&&heading.focus()}function toTodolist(editable,checked,focus){let input=document.createElement("input"),span=document.createElement("span"),line=getLineFromEditable(editable);if(!line)return;input.type="checkbox",input.setAttribute("aria-label","todo list checkbox"),input.addEventListener("input",()=>{line.classList.toggle("todo-checked",input.checked),line.classList.toggle("todo",!input.checked),input.checked?input.setAttribute("checked",""):input.removeAttribute("checked")}),checked&&input.setAttribute("checked",""),line.className="line todo"+(checked?"-checked":""),span.className="todo-marker",span.appendChild(input),line.prepend(span);let str=editable.textContent||"";(str.indexOf("[ ]")===0||str.indexOf("[x]")===0)&&(editable.textContent=str.slice(4,str.length)),focus&&editable.focus()}function toList(editable,focus){var _a,_b;let span=document.createElement("span"),line=getLineFromEditable(editable);line&&(span.dataset.content="\u2022",span.className="list-dot",line.className="line list",line.prepend(span),((_a=editable.textContent)===null||_a===void 0?void 0:_a.indexOf("-"))===0&&(editable.textContent=(_b=editable.textContent)===null||_b===void 0?void 0:_b.replace("-","").trimStart()),focus&&editable.focus())}var lineTransform_default={toHeading,toTodolist,toList};function generateLine(props){let notesline=document.createElement("div"),editable=document.createElement("p");switch(editable.setAttribute("contenteditable","true"),notesline.classList.add("line"),notesline.appendChild(editable),typeof props?.text=="string"&&(editable.textContent=props.text),props?.modif){case"todo":lineTransform_default.toTodolist(editable,!1);break;case"todo-checked":lineTransform_default.toTodolist(editable,!0);break;case"list":lineTransform_default.toList(editable);break;case"h1":case"h2":case"h3":lineTransform_default.toHeading(editable,props?.modif);break}return notesline}var modList=[["h1","#"],["h2","##"],["h3","###"],["list","-"],["todo","[ ]"],["todo-checked","[x]"]],modList_default=modList;function checkModifs(text){for(let[name,str]of modList_default)if(text.startsWith(str+" "))return name;return""}function toHTML(markdown){let fragment=document.createDocumentFragment();markdown=markdown.replaceAll("	","");for(let line of markdown.split(`

`)){if(line.indexOf(`
`)===-1){fragment.appendChild(generateLine({text:line,modif:checkModifs(line)}));continue}for(let subline of line.split(`
`))fragment.appendChild(generateLine({text:subline,modif:checkModifs(subline)}))}return fragment}function toMarkdown(lines){function addModif(line){return line.classList.contains("list")?"- ":line.classList.contains("h1")?"# ":line.classList.contains("h2")?"## ":line.classList.contains("h3")?"### ":line.classList.contains("todo")?"[ ] ":line.classList.contains("todo-checked")?"[x] ":""}let plaintext="",modif="",isList=line=>line?.classList.contains("list")||line?.classList.contains("todo");return lines.forEach((line,i)=>{modif=addModif(line),plaintext+=modif+line.textContent;let isWithinList=isList(lines[i+1])&&isList(line),isLastLine=lines.length-1===i;plaintext+=isLastLine?"":isWithinList?`
`:`

`}),plaintext}function lastTextNode(line){let lastNode=line;for(;lastNode?.childNodes.length>0;){let childNodes=Object.values(lastNode.childNodes).reverse(),textNodes=childNodes.filter(child=>child.nodeName==="#text");if(textNodes.length>0)return textNodes[0];lastNode=childNodes[0]}return lastNode}function setCaret(elem,atStart){var _a;let node=lastTextNode(elem),sel=window.getSelection(),range=document.createRange(),textlen=((_a=node.nodeValue)===null||_a===void 0?void 0:_a.length)||0;range.setStart(node,atStart?0:textlen),range.setEnd(node,atStart?0:textlen),sel?.removeAllRanges(),sel?.addRange(range),sel?.collapseToEnd()}function insertAfter(newNode,existingNode){var _a;(_a=existingNode?.parentNode)===null||_a===void 0||_a.insertBefore(newNode,existingNode.nextSibling)}function removeLines(lines){let container=getContainer(),emptyLine=generateLine(),prevline=getPrevLine(lines[0]);lines.forEach(line=>line.remove()),prevline?insertAfter(emptyLine,prevline):container.prepend(emptyLine),setCaret(emptyLine),container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}function copyEvent(e){var _a;let selected=getSelectedLines();selected.length>0&&((_a=e.clipboardData)===null||_a===void 0||_a.setData("text/plain",toMarkdown(selected)),e.preventDefault())}function cutEvent(e){var _a;let selected=getSelectedLines();selected.length>0&&((_a=e.clipboardData)===null||_a===void 0||_a.setData("text/plain",toMarkdown(selected)),e.preventDefault(),removeLines(selected))}function pasteEvent(e){var _a;e.preventDefault();let container=getContainer(),selection=window.getSelection(),range=selection?.getRangeAt(0),text=((_a=e.clipboardData)===null||_a===void 0?void 0:_a.getData("text"))||"";if(checkModifs(text)!==""){let editable=e.target,newHTML=toHTML(text),linesInNew=newHTML.childElementCount-1,lines=getLines(),line=getLineFromEditable(editable),selected=getSelectedLines();if(selected.length>0&&(line=selected[selected.length-1]),!line?.classList.contains("line"))return;container.insertBefore(newHTML,getNextLine(line,lines));let lastline=line.nextSibling;for(let ii=0;ii<linesInNew;ii++)lastline&&(lastline=lastline.nextSibling);if(lastline&&setCaret(lastline),line&&line.textContent===""){let areSameMods=mod=>{var _a2;let curr=line?.classList,next=(_a2=getNextLine(line,lines))===null||_a2===void 0?void 0:_a2.classList;return curr?.contains(mod)===next?.contains(mod)};(line.classList.length>1||areSameMods("list")||areSameMods("todo")||areSameMods("todo-checked"))&&line.remove()}container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}selection?.rangeCount&&range&&(selection.deleteFromDocument(),range.endContainer.nodeValue?range.endContainer.nodeValue=range.endContainer.nodeValue+text:range.insertNode(document.createTextNode(text)),setCaret(range.endContainer)),container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function removeModifier(editable){let content=document.createElement("div"),parent=editable.parentElement;parent&&(parent.className="line",content.textContent=parent.textContent,content.setAttribute("contenteditable","true"),Object.values(parent.childNodes).forEach(node=>node.remove()),parent.appendChild(content),content.focus())}var history=[];function addUndoHistory(lastline){var _a,_b;let lines=getLines(),markdown=toMarkdown(lines),index=lastline?lines.indexOf(lastline):0;(_b=markdown===((_a=history[0])===null||_a===void 0?void 0:_a.markdown))!==null&&_b!==void 0&&_b||(history.unshift({markdown,index}),history.length>50&&history.pop())}function initUndo(){let container=getContainer(),timeout;new MutationObserver(()=>{timeout&&clearTimeout(timeout)}).observe(container,{characterData:!0,subtree:!0}),container.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="z"&&(timeout=window.setTimeout(()=>{applyUndo()},1))})}function applyUndo(){var _a;let container=getContainer(),{markdown,index}=(_a=history[0])!==null&&_a!==void 0?_a:{};markdown&&(Object.values(container.children).forEach(node=>node.remove()),container.appendChild(toHTML(markdown)),setTimeout(()=>{let editable=container.querySelectorAll("[contenteditable]")[index];editable&&(editable.focus(),setCaret(editable,!1))},0),history.shift(),container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""})))}function paragraphControl(e){var _a,_b,_c,_d,_e,_f,_g,_h;let container=getContainer(),editable=e.target,range;try{let isContenteditable=editable?.hasAttribute("contenteditable"),isInput=editable?.tagName==="INPUT";if(range=(_a=window.getSelection())===null||_a===void 0?void 0:_a.getRangeAt(0),!range||!isContenteditable||isInput)throw""}catch{return}let line=getLineFromEditable(editable),insertParagraph=((_b=e)===null||_b===void 0?void 0:_b.inputType)==="insertParagraph",insertText=((_c=e)===null||_c===void 0?void 0:_c.inputType)==="insertText",modif;if(e.type==="beforeinput"&&insertParagraph&&line){e.preventDefault(),addUndoHistory(line);let cuttext=((_d=editable.textContent)!==null&&_d!==void 0?_d:"").slice(0,range.startOffset),nexttext=((_e=editable.textContent)!==null&&_e!==void 0?_e:"").slice(range.startOffset);if(range.startOffset===0&&((_f=line?.classList)===null||_f===void 0?void 0:_f.length)>1){removeModifier(editable);return}line?.classList.contains("todo")&&(modif="todo"),line?.classList.contains("list")&&(modif="list"),line?.classList.contains("todo-checked")&&(modif="todo");let nextline=getNextLine(line),newline=generateLine({text:nexttext,modif});nextline?container.insertBefore(newline,nextline):container?.appendChild(newline),(_g=newline.querySelector("[contenteditable]"))===null||_g===void 0||_g.focus(),editable.textContent=cuttext,container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(e.type==="input"&&insertText){let isTargetTitle=editable?.tagName.includes("H"),content=(_h=editable?.textContent)!==null&&_h!==void 0?_h:"";for(let[mod,val]of modList_default){let softspace=String.fromCharCode(160),hardspace=String.fromCharCode(32);(content.startsWith(val+hardspace)||content.startsWith(val+softspace))&&(modif=mod)}modif?.includes("h")&&lineTransform_default.toHeading(editable,modif,!0),isTargetTitle===!1&&(modif==="todo"&&lineTransform_default.toTodolist(editable,!1,!0),modif==="list"&&lineTransform_default.toList(editable,!0))}}function detectLineJump(e){var _a,_b,_c,_d,_e;if(!e.key.includes("Arrow")||!(!((_a=window.getSelection())===null||_a===void 0)&&_a.anchorNode))return;let editable=e.target,lines=getLines(),line=getLineFromEditable(editable),range=(_b=window?.getSelection())===null||_b===void 0?void 0:_b.getRangeAt(0),txtLen=(_e=(_d=(_c=range?.startContainer)===null||_c===void 0?void 0:_c.nodeValue)===null||_d===void 0?void 0:_d.length)!==null&&_e!==void 0?_e:0;if(!range||!line)return;let prevSibling=getPrevLine(line,lines),nextSibling=getNextLine(line,lines),isCaretAtZero=Math.min(range?.endOffset,range?.startOffset)===0,isCaretAtEnd=Math.max(range?.endOffset,range?.startOffset)===txtLen;if(e.key==="ArrowLeft"&&isCaretAtZero&&prevSibling)return{line,dir:"up"};if(e.key==="ArrowRight"&&isCaretAtEnd&&nextSibling)return{line,dir:"down"};let top=!1,bottom=!1,rr=range?.getBoundingClientRect(),lr=line?.getBoundingClientRect();if(!lr||!rr||rr.y===0?(top=!0,bottom=!0):(top=lr.top-rr.top+rr.height>0,bottom=rr.bottom+rr.height-lr.bottom>0),e.key==="ArrowUp"&&prevSibling&&top)return{line,dir:"up"};if(e.key==="ArrowDown"&&nextSibling&&bottom)return{line,dir:"down"}}function lineSelection(container){let lines=getLines(),caretSelTimeout,lineInterval=[-1,-1],currentLine=-1,firstLine=-1;function caretSelectionDebounce(callback){clearTimeout(caretSelTimeout),caretSelTimeout=window.setTimeout(()=>{callback()},200)}function createRange(selected){var _a,_b;if(selected||(selected=getSelectedLines(lines)),selected.length===0)return;(_a=document.querySelector("#pocket-editor-mock-sel"))===null||_a===void 0||_a.remove();let mockSelection=document.createElement("pre");mockSelection.id="pocket-editor-mock-sel",mockSelection.textContent="mock-selection",mockSelection.setAttribute("contenteditable","true"),container.appendChild(mockSelection);let sel=window.getSelection(),range=document.createRange(),textlen=((_b=mockSelection.childNodes[0].nodeValue)===null||_b===void 0?void 0:_b.length)||0;range.setStart(mockSelection.childNodes[0],0),range.setEnd(mockSelection.childNodes[0],textlen),sel?.removeAllRanges(),sel?.addRange(range)}function getLineIndex(editable){let line=getLineFromEditable(editable);return line?lines.indexOf(line):-1}function resetLineSelection(){var _a;let line=lines[currentLine];line?.querySelector("[contenteditable]")&&setCaret(line),currentLine=-1,firstLine=-1,lineInterval=[-1,-1],(_a=document.querySelector("#pocket-editor-mock-sel"))===null||_a===void 0||_a.remove(),container.removeEventListener("mousemove",mouseMoveEvent)}function addToLineSelection(index){index>firstLine&&(lineInterval[1]=index),index<firstLine&&(lineInterval[0]=index),index===firstLine&&(lineInterval=[index,index])}function changeLineSelection(index){firstLine=index,lineInterval=[index,index]}function applyLineSelection(interval){lines.forEach((line,i)=>{i>=interval[0]&&i<=interval[1]?line.classList.add("sel"):line.classList.remove("sel")}),caretSelectionDebounce(()=>createRange())}function initLineSelection(index){currentLine=firstLine=index,lineInterval=[index,index]}function keyboardEvent(e){var _a,_b,_c,_d;lines=getLines();let selected=getSelectedLines(lines),isClipboardKey=e.key.match(/([x|c|v])/g),isCtrlKey=e.key==="Control"||e.key==="Meta",noSelection=selected.length>0,ctrl=e.ctrlKey||e.metaKey;if(isCtrlKey||ctrl&&isClipboardKey&&noSelection)return;if(ctrl&&e.key==="a"){(_a=window.getSelection())===null||_a===void 0||_a.removeAllRanges(),currentLine=firstLine=0,lineInterval=[0,lines.length-1],applyLineSelection(lineInterval),e.preventDefault();return}if(noSelection){if((_b=window.getSelection())===null||_b===void 0||_b.removeAllRanges(),e.key==="Escape"||e.key==="Tab"){resetLineSelection(),applyLineSelection(lineInterval),e.preventDefault();return}if(e.key.includes("Arrow")){e.key.includes("Down")&&(currentLine=Math.min(currentLine+1,lines.length-1)),e.key.includes("Up")&&(currentLine=Math.max(0,currentLine-1)),e.shiftKey&&addToLineSelection(currentLine),e.shiftKey||changeLineSelection(currentLine),applyLineSelection(lineInterval),e.preventDefault();return}e.code.match(/Shift|Alt|Control|Caps/)||(resetLineSelection(),addUndoHistory(selected[selected.length- -1]),removeLines(selected),e.code==="Enter"&&e.preventDefault())}if(!e.shiftKey)return;let{line}=(_c=detectLineJump(e))!==null&&_c!==void 0?_c:{};if(line){let index=lines.indexOf(line);initLineSelection(index),applyLineSelection(lineInterval),(_d=window.getSelection())===null||_d===void 0||_d.removeAllRanges()}}function mouseMoveEvent(e){var _a;let target=e.target,selected=getSelectedLines(lines);if(selected.length>0&&((_a=window.getSelection())===null||_a===void 0||_a.removeAllRanges()),target.getAttribute("contenteditable")){if(currentLine=getLineIndex(target),currentLine===firstLine&&selected.length===0)return;addToLineSelection(currentLine),applyLineSelection(lineInterval)}}function mouseDownEvent(e){let target=e.target;lines=getLines(),e.button===2&&e.preventDefault(),e.button===0&&(resetLineSelection(),applyLineSelection(lineInterval),target.getAttribute("contenteditable")&&(initLineSelection(getLineIndex(target)),container.addEventListener("mousemove",mouseMoveEvent)))}function mouseClickEvent(e){!e.composedPath().includes(container)&&(lines=getLines(),resetLineSelection(),applyLineSelection(lineInterval)),container.removeEventListener("mousemove",mouseMoveEvent)}window.addEventListener("touchend",mouseClickEvent),window.addEventListener("click",mouseClickEvent),container.addEventListener("keydown",keyboardEvent),container.addEventListener("mousedown",mouseDownEvent)}function removeLineNoText(editable,prevline){var _a;setCaret(prevline),(_a=editable.parentElement)===null||_a===void 0||_a.remove()}function removeLineWithText(editable,prevLine){var _a;let node=lastTextNode(prevLine),isTextNode=node.nodeType===3,charAmount=((_a=node.nodeValue)===null||_a===void 0?void 0:_a.length)||0,targetText=editable?.textContent||"";node[isTextNode?"nodeValue":"textContent"]+=targetText;let selection=window.getSelection(),range=document.createRange();range.setStart(node,isTextNode?charAmount:0),range.setEnd(node,isTextNode?charAmount:0),selection?.removeAllRanges(),selection?.addRange(range),editable.parentElement.remove()}function lineDeletion(){let container=getContainer(),sel=window.getSelection();function applyLineRemove(e){var _a;let editable=e.target,line=getLineFromEditable(editable),isEditable=!!editable.getAttribute("contenteditable"),isAtStart=((_a=sel?.getRangeAt(0))===null||_a===void 0?void 0:_a.endOffset)===0,isDelEvent=e.inputType==="deleteContentBackward";if(e.type==="beforeinput"&&!isDelEvent||!isAtStart||!isEditable)return;if(e.preventDefault(),line&&addUndoHistory(line),line?.classList.length>1){removeModifier(editable);return}let prevline=getPrevLine(line);prevline&&(editable.textContent===""&&removeLineNoText(editable,prevline),editable.textContent!==""&&removeLineWithText(editable,prevline))}if(container.addEventListener("beforeinput",applyLineRemove),navigator.userAgent.includes("Safari")&&container.addEventListener("keydown",e=>{try{let range=sel?.getRangeAt(0),isBackspacing=e.key==="Backspace",isAtContainerStart=range?.startOffset===0;isBackspacing&&isAtContainerStart&&applyLineRemove(e)}catch{}}),"ontouchstart"in window||navigator.maxTouchPoints>0){let touchDeleteDebounce,inputEventPrevents=!1;container.addEventListener("input",()=>inputEventPrevents=!0),container.addEventListener("keyup",function(ev){var _a,_b;if(inputEventPrevents||((_a=ev)===null||_a===void 0?void 0:_a.key)!=="Unidentified"||((_b=sel?.getRangeAt(0))===null||_b===void 0?void 0:_b.endOffset)!==0){clearTimeout(touchDeleteDebounce),inputEventPrevents=!1;return}touchDeleteDebounce=window.setTimeout(()=>applyLineRemove(ev),5)})}}function caretControl(container){let averageCharWidth=0;function initAverageCharWidth(){var _a;let p=document.createElement("p"),span=document.createElement("span");p.id="pocket-editor-mock-p",span.textContent="abcdefghijklmnopqrstuvwxyz",p?.appendChild(span),(_a=container.querySelector(".line [contenteditable]"))===null||_a===void 0||_a.appendChild(p),averageCharWidth=span.offsetWidth/26/2,p.remove()}function rangePosInCharLen(line,str){var _a,_b,_c,_d;let sel=window.getSelection(),editable=line?.querySelector("[contenteditable]"),cx=(_a=editable?.getBoundingClientRect().x)!==null&&_a!==void 0?_a:0,ox=((_d=(_c=(_b=sel?.getRangeAt(0))===null||_b===void 0?void 0:_b.cloneRange())===null||_c===void 0?void 0:_c.getBoundingClientRect().x)!==null&&_d!==void 0?_d:0)-cx,charCount=-1,textnode=lastTextNode(editable),range=document.createRange();range.setStart(textnode,0),range.setEnd(textnode,0);let rangeX=0;for(let i=0;i<str.length-1;i++){try{range.setStart(textnode,i),range.setEnd(textnode,i)}catch{break}if(rangeX=range.getBoundingClientRect().x-cx,rangeX+averageCharWidth>=ox){charCount=i;break}}return charCount}function getParagraphAsArray(line){var _a;let editable=line?.querySelector("[contenteditable]");if(!editable)return console.warn("Couldn't get string[], no contenteditable found"),[];let pos=0,rangeY=0,rangeYlast=0,lines=[""],words=((_a=editable.textContent)!==null&&_a!==void 0?_a:"").split(" "),textnode=lastTextNode(editable),range=document.createRange();range.setStart(textnode,0),range.setEnd(textnode,0);let isWebkit=navigator.userAgent.includes("AppleWebKit");rangeYlast=rangeY=range.getBoundingClientRect().y;for(let word of words){word=word+" ",pos+=word.length;try{range.setStart(textnode,pos),range.setEnd(textnode,pos),rangeY=range.getBoundingClientRect().y}catch{}isWebkit&&(lines[0]+=word),rangeY>rangeYlast&&(isWebkit&&(lines[0]=lines[0].trimEnd()),lines.unshift(""),rangeYlast=rangeY),isWebkit===!1&&(lines[0]+=word)}return lines.reverse(),lines}container.addEventListener("keydown",function(e){var _a,_b,_c,_d,_e,_f,_g;let{line,dir}=(_a=detectLineJump(e))!==null&&_a!==void 0?_a:{},lines=getLines();if(!line)return;let goesRight=e.key==="ArrowRight",goesLeft=e.key==="ArrowLeft",sel=window.getSelection(),range=document.createRange(),offset=0,node;if(averageCharWidth===0&&initAverageCharWidth(),dir==="down"){let nextline=(_b=getNextLine(line,lines))!==null&&_b!==void 0?_b:line;node=lastTextNode(nextline);let textlen=((_c=node.nodeValue)===null||_c===void 0?void 0:_c.length)||0;if(!goesRight){let rows=getParagraphAsArray(nextline);offset=(_d=rangePosInCharLen(nextline,rows[0]))!==null&&_d!==void 0?_d:-1,offset<0&&(offset=textlen)}}if(dir==="up"){let prevline=(_e=getPrevLine(line,lines))!==null&&_e!==void 0?_e:line;node=lastTextNode(prevline);let textlen=((_f=node.nodeValue)===null||_f===void 0?void 0:_f.length)||0;if(offset=textlen,!goesLeft){let rows=getParagraphAsArray(prevline),lastrow=rows[rows.length-1].trimEnd(),lastrowOffset=(_g=rangePosInCharLen(prevline,lastrow))!==null&&_g!==void 0?_g:textlen;offset=textlen-(lastrow.length-lastrowOffset),lastrowOffset<0&&(offset=textlen)}}try{range.setStart(node,offset),range.setEnd(node,offset),sel?.removeAllRanges(),sel?.addRange(range),sel?.collapseToEnd(),e.preventDefault()}catch{console.log(node),console.log("oupsie")}})}function pocketEditor(wrapper){var _a;let container=setContainer(document.createElement("div"));function set2(string){Object.values(container.children).forEach(node=>node.remove()),container.appendChild(toHTML(string))}function get2(){return toMarkdown(getLines(container))}function oninput(callback){function cb(e){e.type==="beforeinput"&&!e.inputType.match(/(deleteContentBackward|insertParagraph)/g)||callback()}return container.addEventListener("cut",cb),container.addEventListener("paste",cb),container.addEventListener("input",cb),container.addEventListener("beforeinput",cb),()=>{container.removeEventListener("cut",cb),container.removeEventListener("paste",cb),container.removeEventListener("input",cb),container.removeEventListener("beforeinput",cb)}}if(container.id="pocket-editor",setTimeout(()=>{container.addEventListener("beforeinput",paragraphControl),container.addEventListener("input",paragraphControl),container.addEventListener("paste",pasteEvent),container.addEventListener("copy",copyEvent),container.addEventListener("cut",cutEvent),lineSelection(container),caretControl(container),lineDeletion(),initUndo()},0),container.appendChild(generateLine({text:""})),(_a=document.getElementById(wrapper))===null||_a===void 0||_a.appendChild(container),document.getElementById(wrapper)===null)throw'Pocket editor: id "'+wrapper+'" was not found';return{set:set2,get:get2,oninput}}function translateNotesText(){let lang=document.documentElement.getAttribute("lang");lang&&lang in langs_default||(lang="en");let or=tradThis("or"),edit=tradThis("Edit this note"),titles=tradThis("to create titles"),lists=tradThis("to add a list or checkbox");return[`## ${edit} !

`,`[x] "# ", "## " ${or} "### " ${titles}
`,`[x] "- " ${or} "[ ] " ${lists}`].join("")}async function notes(init,event){let container=document.getElementById("notes_container");function handleToggle(state){container&&container?.classList.toggle("hidden",!state)}function handleAlign(value){container?.classList.toggle("center-align",value==="center"),container?.classList.toggle("right-align",value==="right")}function handleWidth(value){value&&document.documentElement.style.setProperty("--notes-width",value.toString()+"em")}function handleOpacity(value){container&&(container?.classList.toggle("opaque",value>.45),document.documentElement.style.setProperty("--notes-background-alpha",value.toString()))}function updateNotes(notes2,event2){switch(event2?.is){case"change":{notes2.text=event2.value;break}case"align":{handleAlign(event2.value),notes2.align=event2.value;break}case"width":{notes2.width=parseInt(event2.value),handleWidth(notes2.width);break}case"opacity":{handleOpacity(parseFloat(event2.value)),notes2.opacity=parseFloat(event2.value);break}}eventDebounce({notes:notes2})}if(event){let data=await storage_default.get("notes");updateNotes(data.notes,event);return}if(!init)return;document.getElementById("pocket-editor")&&document.getElementById("pocket-editor")?.remove();let editor=pocketEditor("notes_container");handleAlign(init.align),handleWidth(init.width),handleOpacity(init.opacity),handleToggle(init.on),editor.set(typeof init.text=="string"?init.text:translateNotesText()),editor.oninput(()=>notes(init,{is:"change",value:editor.get()}))}function getUserQuoteSelection(){return parseInt(localStorage.userQuoteSelection||"0")}function userlistToQuotes(arr=[["",""]]){return arr?.map(([author,content])=>({author,content}))}async function newQuoteFromAPI(lang,type){try{if(!navigator.onLine||type==="user")return[];let query=type+=type==="classic"?`/${lang}`:"",API=Math.random()>.5?"aHR0cHM6Ly9xdW90ZXMuYm9uam91cnIuZnIv":"aHR0cHM6Ly9xdW90ZXMuYm9uam91cnIuZnIv",response=await fetch(atob(API)+query),json=await response.json();if(response.ok)return json}catch(error){return console.warn(error),[]}}function insertToDom(values){let quoteDOM=document.getElementById("quote"),authorDOM=document.getElementById("author");!values||!quoteDOM||!authorDOM||(quoteDOM.textContent=values.content,authorDOM.textContent=values.author)}function controlCacheList(list,lang,type){if(type==="user"){let randIndex=Math.round(Math.random()*(list.length-1));return localStorage.setItem("userQuoteSelection",JSON.stringify(randIndex)),list[randIndex]}return list.shift(),localStorage.setItem("quotesCache",JSON.stringify(list)),list.length<2&&newQuoteFromAPI(lang,type).then(list2=>{localStorage.setItem("quotesCache",JSON.stringify(list2))}),list[0]}function UpdateQuotes({author,frequency,type,userlist,refresh},{quotes:quotes2,lang}){let quotesCache=parse(localStorage.quotesCache)??[];async function handleQuotesType(type2){let list=[],{userlist:userlist2}=quotes2;if(document.getElementById("quotes_userlist")?.classList.toggle("shown",type2==="user"),type2==="user"&&!userlist2)return;if(type2!=="user"){list=await newQuoteFromAPI(lang,type2),localStorage.setItem("quotesCache",JSON.stringify(list)),insertToDom(list[0]);return}let selection=getUserQuoteSelection();list=userlistToQuotes(userlist2),insertToDom(list[selection])}function handleUserListChange(userlist2){function validateUserQuotes(json){return Array.isArray(json)&&json.length>0&&json.every(val=>val.length===2)&&json.flat().every(val=>typeof val=="string")}function inputError(log){let input=document.getElementById("i_qtlist");input.value="",console.log(log)}let array=[],quote={author:"",content:""};if(userlist2!==""){let userJSON=parse(userlist2);if(!userJSON)return inputError("User quotes list is not valid JSON"),quotes2.userlist;if(validateUserQuotes(userJSON)===!1)return inputError("User quotes list is not of type [string, string][]"),quotes2.userlist;array=userJSON,quote={author:array[0][0],content:array[0][1]}}return insertToDom(quote),document.getElementById("i_qtlist")?.blur(),localStorage.setItem("userQuoteSelection","0"),array}function handleQuotesRefresh(){if(quotes2.type==="user"){if(!quotes2.userlist)return;quotesCache=userlistToQuotes(quotes2.userlist)}let quote=controlCacheList(quotesCache,lang,quotes2.type);insertToDom(quote)}author&&(quotes2.author=author,document.getElementById("author")?.classList.toggle("always-on",author)),frequency&&(quotes2.frequency=frequency),type&&(quotes2.type=type,handleQuotesType(type)),userlist&&(quotes2.userlist=handleUserListChange(userlist)),refresh&&(quotes2.last=freqControl.set(),handleQuotesRefresh()),storage_default.set({quotes:quotes2})}async function quotes(init,update2){if(update2){let data=await storage_default.get(["lang","quotes"]);UpdateQuotes(update2,data)}if(!init)return;let{lang,quotes:quotes2}=init,isUser=quotes2.type==="user",needsNewQuote=freqControl.get(quotes2.frequency,quotes2.last),userSel=getUserQuoteSelection(),cache=parse(localStorage.quotesCache)??[],quote;(!cache||cache?.length===0)&&(cache=await newQuoteFromAPI(lang,quotes2.type),localStorage.setItem("quotesCache",JSON.stringify(cache))),isUser&&(cache=userlistToQuotes(quotes2.userlist)),needsNewQuote?(quotes2.last=freqControl.set(),quote=controlCacheList(cache,lang,quotes2.type),storage_default.set({quotes:quotes2})):quote=cache[isUser?userSel:0],quotes2.author&&document.getElementById("author")?.classList.add("always-on"),isUser&&quotes2.userlist?insertToDom(userlistToQuotes(quotes2.userlist)[userSel]):isUser||insertToDom(cache[0]),insertToDom(quote),document.getElementById("quotes_container")?.classList.toggle("hidden",!quotes2.on),canDisplayInterface("quotes")}function weather(init,event){let date=new Date;async function request(storage){function getRequestURL(isForecast){let key=["MzI4NmE5ZGQ4MmQ2NzBlNWIzYmVhZjcxYjQwZDk0ODY=","Y2IxZGFmYzBlNjg5ZTM4ZWQxMGZmYjU0ZDkyMTkzNDc=","NmIyOWI5NDhjZWYxNTk1OTEwYjgyYmI2OTUzOGFjMzU=","YmU5ZDkwZTlkYTk5N2IxOWJhOTFhZGZjOGJiODhiNjI="][Math.ceil(Math.random()*4)-1],isGeolocated=storage.location?.length===2,base="https://api.openweathermap.org/data/2.5/",lang=document.documentElement.getAttribute("lang");return lang==="zh_HK"&&(lang="zh_TW"),lang==="gr"&&(lang="el"),base+=isForecast?"forecast/":"weather/",base+="?units="+(storage.unit??"metric"),base+="&lang="+lang,isGeolocated?(base+="&lat="+storage.location[0],base+="&lon="+storage.location[1]):(base+="&q="+encodeURI(storage.city??"Paris"),base+=","+storage.ccode),base+="&appid="+atob(key),base}if(!navigator.onLine)return storage;let currentResponse,forecastResponse,currentJSON,forecastJSON;try{currentResponse=await fetch(getRequestURL(!1)),forecastResponse=await fetch(getRequestURL(!0)),currentJSON=await currentResponse.json(),forecastJSON=await forecastResponse.json()}catch{return storage}if(!currentResponse.ok||!forecastResponse.ok)return storage;let{temp,feels_like,temp_max}=currentJSON.main,{sunrise:sunrise2,sunset:sunset2}=currentJSON.sys,{description,id}=currentJSON.weather[0];storage={...storage,lastCall:Math.floor(new Date().getTime()/1e3),lastState:{temp,feels_like,temp_max,sunrise:sunrise2,sunset:sunset2,description,icon_id:id}};let thisdate=new Date,todayHour=thisdate.getHours(),forecastDay=thisdate.getDate(),maxTempFromList=-273.15;if(todayHour>18){let tomorrow=thisdate.setDate(thisdate.getDate()+1);forecastDay=new Date(tomorrow).getDate()}return forecastJSON.list.forEach(elem=>{new Date(elem.dt*1e3).getDate()===forecastDay&&maxTempFromList<elem.main.temp_max&&(maxTempFromList=elem.main.temp_max)}),storage.fcHigh=Math.round(maxTempFromList),storage}async function weatherCacheControl(data){let now=Math.floor(date.getTime()/1e3);typeof data.lastCall=="number"?(navigator.onLine&&(now>data.lastCall+1800||sessionStorage.lang)&&(sessionStorage.removeItem("lang"),data=await request(data),storage_default.set({weather:data})),displayWeather(data)):initWeather(data)}async function initWeather(data){async function getInitialPositionFromIpapi(){try{let ipapi=await fetch("https://ipapi.co/json");if(ipapi.ok){let{error,city,country,latitude,longitude}=await ipapi.json();if(!error)return{city,ccode:country,location:[latitude,longitude]}}}catch{return{city:"Paris",ccode:"FR"}}}async function setWeatherAfterGeolocation(location2){data={...data,...await getInitialPositionFromIpapi()},location2&&(data.location=location2),data=await request(data),displayWeather(data),storage_default.set({weather:data}),setTimeout(()=>{if(document.getElementById("settings")){let i_ccode=document.getElementById("i_ccode"),i_city=document.getElementById("i_city"),i_geol=document.getElementById("i_geol"),sett_city=document.getElementById("sett_city");i_ccode.value=data.ccode,i_city.setAttribute("placeholder",data.city),location2&&(sett_city.classList.remove("shown"),i_geol.checked=!0)}},150)}navigator.geolocation.getCurrentPosition(pos=>setWeatherAfterGeolocation([pos.coords.latitude,pos.coords.longitude]),()=>setWeatherAfterGeolocation())}function displayWeather(data){let currentState=data.lastState,current=document.getElementById("current"),forecast=document.getElementById("forecast"),tempContainer=document.getElementById("tempContainer"),weatherdom=document.getElementById("weather");if(!currentState)return;let handleDescription=()=>{let desc=currentState.description,feels=Math.floor(currentState.feels_like),actual=Math.floor(currentState.temp),tempText="";switch(data.temperature){case"feelslike":{tempText=`${tradThis("It currently feels like")} ${feels}\xB0`;break}case"both":{tempText=`${tradThis("It is currently")} ${actual}\xB0, ${tradThis("feels like")} ${feels}\xB0`;break}default:tempText=`${tradThis("It is currently")} ${actual}\xB0`}let iconText=tempContainer?.querySelector("p");current&&iconText&&(current.textContent=`${desc[0].toUpperCase()+desc.slice(1)}. ${tempText}`,iconText.textContent=actual+"\xB0")},handleWidget=()=>{let filename="lightrain";if([[[200,201,202,210,211,212,221,230,231,232],"thunderstorm"],[[300,301,302,310],"lightdrizzle"],[[312,313,314,321],"showerdrizzle"],[[500,501,502,503],"lightrain"],[[504,520,521,522],"showerrain"],[[511,600,601,602,611,612,613,615,616,620,621,622],"snow"],[[701,711,721,731,741,751,761,762,771,781],"mist"],[[800],"clearsky"],[[801],"fewclouds"],[[802],"brokenclouds"],[[803,804],"overcastclouds"]].forEach(category=>{category[0].includes(currentState.icon_id)&&(filename=category[1])}),!tempContainer)return;let icon=document.getElementById("weather-icon"),{now,rise,set:set2}=sunTime(),iconSrc=`src/assets/weather/${now<rise||now>set2?"night":"day"}/${filename}.png`;icon.src=iconSrc},handleForecast=()=>{if(forecast){let day=tradThis(date.getHours()>21?"tomorrow":"today");day=day!==""?" "+day:"",forecast.textContent=`${tradThis("with a high of")} ${data.fcHigh}\xB0${day}.`,forecast.classList.remove("wait")}},handleMoreInfo=()=>{let noDetails=!data.moreinfo||data.moreinfo==="none",emptyCustom=data.moreinfo==="custom"&&!data.provider;if(noDetails||emptyCustom){weatherdom?.removeAttribute("href");return}let URLs={msnw:"https://www.msn.com/en-us/weather/forecast/",yhw:"https://www.yahoo.com/news/weather/",windy:"https://www.windy.com/",custom:data.provider??""};(data.moreinfo||"")in URLs&&weatherdom?.setAttribute("href",URLs[data.moreinfo])};handleWidget(),handleDescription(),handleForecast(),handleMoreInfo(),current?.classList.remove("wait"),tempContainer?.classList.remove("wait")}function forecastVisibilityControl(value="auto"){let forcastdom=document.getElementById("forecast"),isTimeForForecast=!1;value==="auto"?isTimeForForecast=date.getHours()<12||date.getHours()>21:isTimeForForecast=value==="always",forcastdom?.classList.toggle("shown",isTimeForForecast)}async function updatesWeather(){let i_city=document.getElementById("i_city"),i_ccode=document.getElementById("i_ccode"),sett_city=document.getElementById("sett_city"),{weather:weather2,hide}=await storage_default.get(["weather","hide"]);if(!(!weather2||!hide)){switch(event?.is){case"units":{weather2.unit=event.checked?"imperial":"metric",weather2=await request(weather2);break}case"city":{if(i_city.value.length<3||!navigator.onLine)return!1;weather2.ccode=i_ccode.value,weather2.city=stringMaxSize(i_city.value,64);let inputAnim=i_city.animate([{opacity:1},{opacity:.6}],{direction:"alternate",easing:"linear",duration:800,iterations:1/0});weather2=await request(weather2),i_city.value="",i_city.blur(),inputAnim.cancel(),i_city.setAttribute("placeholder",weather2.city);break}case"geol":{if(weather2.location=[],event.checked){navigator.geolocation.getCurrentPosition(async pos=>{sett_city?.classList.toggle("shown",!1),weather2.location=[pos.coords.latitude,pos.coords.longitude],weather2=await request(weather2),storage_default.set({weather:weather2}),displayWeather(weather2)},()=>{setTimeout(()=>event.checked=!1,400)});return}else i_city.setAttribute("placeholder",weather2.city),sett_city?.classList.toggle("shown",!0),i_ccode.value=weather2.ccode,weather2.location=[],weather2=await request(weather2);break}case"forecast":{weather2.forecast=event.value??"auto",forecastVisibilityControl(event.value);break}case"temp":{weather2.temperature=event.value??"actual";break}case"moreinfo":{document.getElementById("weather_provider")?.classList.toggle("shown",event.value==="custom"),weather2.moreinfo=event.value;break}case"provider":{weather2.provider=event.value;break}case"unhide":{let{weatherdesc,weathericon}=hide||{};weatherdesc&&weathericon&&(forecastVisibilityControl(weather2.forecast),weatherCacheControl(weather2));return}}storage_default.set({weather:weather2}),displayWeather(weather2)}}if(event){updatesWeather();return}if(!(!init||init.hide?.weatherdesc&&init.hide?.weathericon))try{forecastVisibilityControl(init.weather.forecast),weatherCacheControl(init.weather)}catch(e){errorMessage(e)}}setInterval(async()=>{if(navigator.onLine){let data=await storage_default.get(["weather","hide"]);data&&weather(data)}},3e5);var domcontainer=document.getElementById("sb_container"),domsearchbar=document.getElementById("searchbar"),emptyButton=document.getElementById("sb_empty"),display=shown=>domcontainer?.classList.toggle("hidden",!shown),setEngine=value=>domsearchbar?.setAttribute("data-engine",value),setRequest=value=>domsearchbar?.setAttribute("data-request",stringMaxSize(value,512)),setNewtab=value=>domsearchbar?.setAttribute("data-newtab",value.toString()),setPlaceholder=(value="")=>domsearchbar?.setAttribute("placeholder",value||""),setOpacity=(value=.1)=>{document.documentElement.style.setProperty("--searchbar-background-alpha",value.toString()),document.getElementById("sb_container")?.classList.toggle("opaque",value>.4)};function submitSearch(e){if(!domsearchbar)return;e.preventDefault();let URLs={google:"https://www.google.com/search?q=%s",ddg:"https://duckduckgo.com/?q=%s",startpage:"https://www.startpage.com/do/search?query=%s",qwant:"https://www.qwant.com/?q=%s",yahoo:"https://search.yahoo.com/search?q=%s",bing:"https://www.bing.com/search?q=%s",brave:"https://search.brave.com/search?q=%s",ecosia:"https://www.ecosia.org/search?q=%s",lilo:"https://search.lilo.org/?q=%s",baidu:"https://www.baidu.com/s?wd=%s"},searchURL="https://www.google.com/search?q=%s",isNewtab=domsearchbar?.dataset.newtab==="true",engine=domsearchbar?.dataset.engine||"google",request=domsearchbar?.dataset.request||"";searchURL=tradThis(engine),!searchURL.includes("%s")&&engine in URLs&&(searchURL=URLs[engine]),engine==="custom"&&(searchURL=request),searchURL=searchURL.replace("%s",encodeURIComponent(domsearchbar?.value??"")),window.open(searchURL,isNewtab?"_blank":"_self")}function toggleInputButton(enabled){document.getElementById("sb-buttons")?.classList.toggle("shown",enabled),document.getElementById("sb_empty")?.toggleAttribute("disabled",!enabled),document.getElementById("sb_submit")?.toggleAttribute("disabled",!enabled)}function handleInputButtons(){domsearchbar&&toggleInputButton(domsearchbar.value.length>0)}function removeInputText(){domsearchbar&&(domsearchbar.focus(),domsearchbar.value="",toggleInputButton(!1))}async function updateSearchbar({engine,newtab,opacity,placeholder,request}){let{searchbar:searchbar2}=await storage_default.get("searchbar");if(searchbar2){if(engine&&(document.getElementById("searchbar_request")?.classList.toggle("shown",engine==="custom"),searchbar2.engine=engine,setEngine(engine)),newtab!==void 0&&(searchbar2.newtab=newtab,setNewtab(newtab)),opacity!==void 0&&(searchbar2.opacity=parseFloat(opacity),setOpacity(parseFloat(opacity))),placeholder!==void 0&&(searchbar2.placeholder=placeholder,setPlaceholder(placeholder)),request){let val=request.value;val.indexOf("%s")!==-1?(searchbar2.request=stringMaxSize(val,512),request.blur()):val.length>0&&(val="",request.setAttribute("placeholder",tradThis("%s Not found")),setTimeout(()=>request.setAttribute("placeholder",tradThis("Search query: %s")),2e3)),setRequest(val)}eventDebounce({searchbar:searchbar2})}}function searchbar(init,update2){if(update2){updateSearchbar(update2);return}let{on,engine,request,newtab,opacity,placeholder}=init||structuredClone(syncDefaults.searchbar);try{display(on),setEngine(engine),setRequest(request),setNewtab(newtab),setPlaceholder(placeholder),setOpacity(opacity),domcontainer?.addEventListener("submit",submitSearch),domsearchbar?.addEventListener("input",handleInputButtons),emptyButton?.addEventListener("click",removeInputText),on&&setTimeout(()=>domsearchbar?.focus(),100)}catch(e){errorMessage(e)}}var systemfont=function(){let fonts={fallback:{placeholder:"Arial",weights:["500","600","800"]},windows:{placeholder:"Segoe UI",weights:["300","400","600","700","800"]},android:{placeholder:"Roboto",weights:["100","300","400","500","700","900"]},linux:{placeholder:"Fira Sans",weights:["100","200","300","400","500","600","700","800","900"]},apple:{placeholder:"SF Pro Display",weights:["100","200","300","400","500","600","700","800","900"]}},{windows,android,mac,ios}=testOS,notAppleOrWindows=!mac&&!windows&&!ios;return windows?fonts.windows:android?fonts.android:mac||ios?fonts.apple:notAppleOrWindows?fonts.linux:fonts.fallback}();async function fetchFontList(){let fonts=parse(localStorage.fonts)??[];if(fonts.length>0)return fonts;if(!navigator.onLine)return;let a="QUl6YVN5QWt5M0pZYzJyQ09MMWpJc3NHQmdMcjFQVDR5VzE1ak9r",url="https://www.googleapis.com/webfonts/v1/webfonts?sort=popularity&key="+window.atob(a),resp=await fetch(url);if(!resp.ok){console.warn("Couldn't fetch google fonts");return}let json=await resp.json();if(json.items?.length>0&&"family"in json.items[0]){let noRegulars=arr=>arr.map(weight=>weight.replace("regular","400")),noItalics=arr=>arr.filter(str=>!str.includes("italic")),list=json.items.map(item=>({family:item.family,variants:noRegulars(noItalics(item.variants))}));return localStorage.fonts=JSON.stringify(list),list}}async function fetchFontface(url){try{let fontface=(await(await fetch(url)).text()).replace(/(\r\n|\n|\r|  )/gm,"");return localStorage.fontface=fontface,fontface}catch{return null}}async function getNewFont(list,currentFamily){let foundFonts=list.filter(({family})=>family.toUpperCase()===currentFamily.toUpperCase());if(foundFonts.length>0){let{family,variants}=foundFonts[0],weights=(await(await fetch("src/assets/variablefonts.json")).json()??[]).includes(family)?`${variants[0]}..${variants.at(-1)}`:variants.join(";");return{url:encodeURI(`https://fonts.googleapis.com/css2?family=${family.replace(/ /g,"+")}:wght@${weights}`),family,weight:"400",availWeights:variants}}return{url:"",family:"",availWeights:[],weight:testOS.windows?"400":"300"}}function setSize(val){document.documentElement.style.setProperty("--font-size",parseInt(val)/16+"em")}function setWeight(family,weight){let clockWeight=parseInt(weight)>100?systemfont.weights[systemfont.weights.indexOf(weight)-1]:weight;document.documentElement.style.setProperty("--font-weight",weight),document.documentElement.style.setProperty("--font-weight-clock",family?weight:clockWeight)}function setFamily(family,fontface){document.getElementById("fontstyle").textContent=fontface,document.documentElement.style.setProperty("--font-family",family?`"${family}"`:null)}async function setAutocompleteSettings(settingsDom){let fontlist=await fetchFontList(),fragment=new DocumentFragment;for(let item of fontlist??[]){let option=document.createElement("option");option.textContent=item.family,option.value=item.family,fragment.appendChild(option)}settingsDom.querySelector("#dl_fontfamily")?.appendChild(fragment)}async function setWeightSettings(weights,settingsDom){(settingsDom||document.getElementById("settings"))?.querySelectorAll("#i_weight option")?.forEach(option=>{let weightExists=weights.includes(option.value);option.classList.toggle("hidden",!weightExists)})}async function initFontSettings(font,settingsDom){settingsDom.querySelector("#i_customfont")?.setAttribute("placeholder",systemfont.placeholder),setWeightSettings(font.availWeights.length===0?systemfont.weights:font.availWeights,settingsDom),font.family&&setAutocompleteSettings(settingsDom)}async function updateFont({family,weight,size}){let isRemovingFamily=typeof family=="string"&&family.length===0,isChangingFamily=typeof family=="string"&&family.length>1,{font}=await storage_default.get("font");if(isRemovingFamily){let i_customfont=document.getElementById("i_customfont"),i_weight=document.getElementById("i_weight"),domstyle=document.getElementById("fontstyle"),baseWeight=testOS.windows?"400":"300";domstyle.textContent="",document.documentElement.style.setProperty("--font-family",""),document.documentElement.style.setProperty("--font-weight-clock","200"),document.documentElement.style.setProperty("--font-weight",baseWeight),localStorage.removeItem("fontface"),setWeight("","400"),setWeightSettings(systemfont.weights),i_customfont?.blur(),i_customfont.value="",i_weight.value=baseWeight,eventDebounce({font:{size:font.size,url:"",family:"",availWeights:[],weight:baseWeight}})}if(isChangingFamily){let i_weight=document.getElementById("i_weight"),fontlist=await fetchFontList()??[],newfont=await getNewFont(fontlist,family),fontface=await fetchFontface(newfont.url);fontface&&(setFamily(family,fontface),setWeight(family,"400"),i_weight.value="400",setWeightSettings(newfont.availWeights),eventDebounce({font:{size:font.size,...newfont}}))}weight&&(font.weight=weight||"400",setWeight(font.family,font.weight),eventDebounce({font})),size&&(font.size=size,setSize(size),eventDebounce({font}))}async function customFont(init,event){if(event?.initsettings&&init)return initFontSettings(init,event?.initsettings);if(event?.autocomplete)return setAutocompleteSettings(event?.autocomplete);if(event){updateFont(event);return}if(init)try{if(setSize(init.size),setWeight(init.family,init.weight),init.family){let fontface=localStorage.fontface;fontface?.includes("@font-face")||(fontface=await fetchFontface(init.url)),setFamily(init.family,fontface),canDisplayInterface("fonts")}}catch(e){errorMessage(e)}}var domlinkblocks=document.getElementById("linkblocks"),dominterface=document.getElementById("interface");async function initblocks(links,isnewtab){function createBlock(link){let title=stringMaxSize(link.title,64),url=stringMaxSize(link.url,512),img=document.createElement("img"),span=document.createElement("span"),anchor=document.createElement("a"),li=document.createElement("li");return img.alt="",img.loading="lazy",img.setAttribute("draggable","false"),anchor.appendChild(img),anchor.appendChild(span),anchor.setAttribute("draggable","false"),anchor.href=url,anchor.setAttribute("rel","noreferrer noopener"),isnewtab&&(getBrowser()==="safari"?anchor.addEventListener("click",handleSafariNewtab):anchor.setAttribute("target","_blank")),li.id=link._id,li.setAttribute("class","block"),li.appendChild(anchor),textOnlyControl(li,title,domlinkblocks.className==="text"),domlinkblocks.appendChild(li),{icon:img,block:li}}async function fetchNewIcon(dom,url){dom.src="src/assets/interface/loading.svg";let img=new Image,hostname="";try{hostname=new URL(url).hostname}catch{}let result=`https://icons.duckduckgo.com/ip3/${hostname}.ico`,API=Math.random()>.5?"aHR0cHM6Ly9kYXJsaW5nLXBvbnktMzM0YTM0Lm5ldGxpZnkuYXBwLw==":"aHR0cHM6Ly9kYXJsaW5nLXBvbnktMzM0YTM0Lm5ldGxpZnkuYXBwLw==",apiText=await(await fetch(atob(API)+url)).text();return apiText.length>0&&(result=apiText),img.onload=()=>dom.src=result,img.src=result,img.remove(),result}if(links.length>0){domlinkblocks.children&&[...domlinkblocks.children].forEach(li=>li.remove());try{let blocklist=links.map(l=>createBlock(l));blocklist.forEach(({block})=>addEvents(block)),linksDragging(blocklist.map(list=>list.block)),canDisplayInterface("links"),links.map(async(link,index)=>{let dom=blocklist[index].icon;link.icon.includes("loading.svg")?(link.icon=await fetchNewIcon(dom,link.url),storage_default.set({[link._id]:link})):dom.src=link.icon})}catch(e){errorMessage(e)}}else canDisplayInterface("links")}function removeLinkSelection(){domlinkblocks.querySelectorAll("img").forEach(img=>{img?.classList.remove("selected")})}function addEvents(elem){if(testOS.ios){let timer=0;elem.addEventListener("touchstart",function(e){timer=setTimeout(()=>{e.preventDefault(),removeLinkSelection(),displayEditWindow(elem,{x:0,y:0})},600)},{passive:!1}),elem.addEventListener("touchmove",()=>clearTimeout(timer),{passive:!1}),elem.addEventListener("touchend",()=>clearTimeout(timer),{passive:!1})}elem.oncontextmenu=function(e){e.preventDefault(),removeLinkSelection(),displayEditWindow(this,{x:e.x,y:e.y})},elem.onkeyup=function(e){if(e.key==="e"){let{offsetLeft,offsetTop}=e.target;displayEditWindow(this,{x:offsetLeft,y:offsetTop})}}}function linksDragging(LIList){let draggedId="",draggedClone,updatedOrder={},coords={},coordsEntries=[],startsDrag=!1,[cox,coy]=[0,0],interfacemargin=0,deplaceElem=(dom,x,y)=>{dom.style.transform=`translateX(${x}px) translateY(${y}px)`};function initDrag(ex,ey,path){let block=path.find(t=>t.className==="block");if(!block)return;startsDrag=!0,draggedId=block.id,dominterface.style.cursor="grabbing",document.querySelectorAll("#linkblocks li").forEach((block2,i)=>{let{x,y,width,height}=block2.getBoundingClientRect(),blockid=block2.id;updatedOrder[blockid]=i,coords[blockid]={order:i,pos:{x,y},triggerbox:{x:[x+width*.1,x+width*.9],y:[y+height*.1,y+height*.9]}}}),coordsEntries=Object.entries(coords);let draggedDOM=document.getElementById(draggedId),draggedCoord=coords[draggedId];draggedDOM&&(draggedDOM.style.opacity="0",draggedClone=draggedDOM.cloneNode(!0),draggedClone.id="",draggedClone.className="block dragging-clone on",domlinkblocks.appendChild(draggedClone)),draggedCoord&&(cox=ex-draggedCoord.pos.x,coy=ey-draggedCoord.pos.y),deplaceElem(draggedClone,ex-cox-interfacemargin,ey-coy),domlinkblocks?.classList.add("dragging")}function applyDrag(ex,ey){deplaceElem(draggedClone,ex-cox-interfacemargin,ey-coy),coordsEntries.forEach(function([key,val]){if(ex>val.triggerbox.x[0]&&ex<val.triggerbox.x[1]&&ey>val.triggerbox.y[0]&&ey<val.triggerbox.y[1]){let drgO=coords[draggedId]?.order||0,keyO=coords[key]?.order||0,interval=[drgO,keyO],direction=0;drgO<keyO&&(direction=-1),drgO>keyO&&(direction=1),direction>0&&(interval[0]-=1),direction<0&&(interval[0]+=1),interval=interval.sort((a,b)=>a-b),coordsEntries.forEach(([keyBis,coord],index)=>{let neighboor=document.getElementById(keyBis);if(neighboor){if(index>=interval[0]&&index<=interval[1]){let ox=coordsEntries[index+direction][1].pos.x-coord.pos.x,oy=coordsEntries[index+direction][1].pos.y-coord.pos.y;updatedOrder[keyBis]=index+direction,deplaceElem(neighboor,ox,oy);return}updatedOrder[keyBis]=index,deplaceElem(neighboor,0,0)}}),updatedOrder[draggedId]=keyO}})}function endDrag(){if(draggedId&&startsDrag){let neworder=updatedOrder[draggedId],{x,y}=coordsEntries[neworder][1].pos;startsDrag=!1,draggedId="",coords={},coordsEntries=[],deplaceElem(draggedClone,x-interfacemargin,y),draggedClone.className="block dragging-clone",dominterface.style.cursor="",document.body.removeEventListener("mousemove",triggerDragging),setTimeout(async()=>{let data=await storage_default.get();Object.entries(updatedOrder).forEach(([key,val])=>{let link=data[key];link.order=val}),domlinkblocks?.classList.remove("dragging"),eventDebounce({...data}),[...domlinkblocks.children].forEach(li=>li.remove()),initblocks(bundleLinks(data),data.linknewtab)},200)}}let initialpos=[0,0],shortPressTimeout;function triggerDragging(e){let isMouseEvent="buttons"in e,ex=isMouseEvent?e.x:e.touches[0]?.clientX,ey=isMouseEvent?e.y:e.touches[0]?.clientY,thresholdpos=[Math.abs(initialpos[0]-ex),Math.abs(initialpos[1]-ey)];(thresholdpos[0]>10||thresholdpos[1]>10)&&(initialpos=[1e7,1e7],startsDrag?applyDrag(ex,ey):initDrag(ex,ey,e.composedPath())),isMouseEvent&&e.buttons===0&&endDrag(),isMouseEvent||e.preventDefault()}function activateDragMove(e){if(interfacemargin=dominterface.getBoundingClientRect().left,e.type==="touchstart"){let{clientX,clientY}=e.touches[0];initialpos=[clientX||0,clientY||0],document.body.addEventListener("touchmove",triggerDragging)}if(e.type==="mousedown"&&e?.button===0){let{x,y}=e;initialpos=[x,y],document.body.addEventListener("mousemove",triggerDragging)}}LIList.forEach(li=>{li.addEventListener("touchmove",()=>clearTimeout(shortPressTimeout),{passive:!1}),li.addEventListener("touchstart",e=>shortPressTimeout=setTimeout(()=>activateDragMove(e),220),{passive:!1}),li.addEventListener("mousedown",activateDragMove)}),document.body.onmouseleave=endDrag,document.body.addEventListener("touchend",function(){endDrag(),document.body.removeEventListener("touchmove",triggerDragging)},{passive:!1})}function editEvents(){async function submitEvent(){let linkid=document.getElementById("editlink")?.dataset.linkid||"";return await updatesEditedLink(linkid)}function inputSubmitEvent(e){e.code==="Enter"&&(e.target.blur(),submitEvent())}document.getElementById("e_delete")?.addEventListener("click",function(){let editlink=document.getElementById("editlink"),linkid=editlink?.dataset.linkid||"";removeLinkSelection(),removeblock(linkid),editlink?.classList.remove("shown")}),document.getElementById("e_submit")?.addEventListener("click",async function(){await submitEvent()&&(closeEditLink(),removeLinkSelection())}),document.getElementById("e_title")?.addEventListener("keyup",inputSubmitEvent),document.getElementById("e_url")?.addEventListener("keyup",inputSubmitEvent),document.getElementById("e_iconurl")?.addEventListener("keyup",inputSubmitEvent)}async function displayEditWindow(domlink,{x,y}){function positionsEditWindow(){let{innerHeight,innerWidth}=window;removeLinkSelection(),x+250>innerWidth&&(x-=x+250-innerWidth),y+200>innerHeight&&(y-=200);let domeditlink=document.getElementById("editlink");domeditlink&&(domeditlink.style.transform=`translate(${x+3}px, ${y+3}px)`)}let linkId=domlink.id,domicon=domlink.querySelector("img"),domedit=document.querySelector("#editlink"),opendedSettings=document.getElementById("settings")?.classList.contains("shown")??!1,data=await storage_default.get(linkId),{title,url,icon}=data[linkId],domtitle=document.getElementById("e_title"),domurl=document.getElementById("e_url"),domiconurl=document.getElementById("e_iconurl");domtitle.setAttribute("placeholder",tradThis("Title")),domurl.setAttribute("placeholder",tradThis("Link")),domiconurl.setAttribute("placeholder",tradThis("Icon")),domtitle.value=title,domurl.value=url,domiconurl.value=icon,positionsEditWindow(),domedit?.classList.add("shown"),domicon?.classList.add("selected"),domedit?.classList.toggle("pushed",opendedSettings),domedit?.setAttribute("data-linkid",linkId),!testOS.ios&&!mobilecheck()&&domtitle.focus()}async function updatesEditedLink(linkId){let e_iconurl=document.getElementById("e_iconurl"),e_title=document.getElementById("e_title"),e_url=document.getElementById("e_url");if(e_iconurl.value.length===7500)return e_iconurl.value="",e_iconurl.setAttribute("placeholder",tradThis("Icon must be < 8kB")),!1;let data=await storage_default.get(linkId),domlink=document.getElementById(linkId),domicon=domlink.querySelector("img"),domurl=domlink.querySelector("a"),link=data[linkId];return link={...link,title:stringMaxSize(e_title.value,64),url:stringMaxSize(e_url.value,512),icon:stringMaxSize(e_iconurl.value,7500)},textOnlyControl(domlink,link.title,domlinkblocks.className==="text"),domurl.href=link.url,domicon.src=link.icon,storage_default.set({[linkId]:link}),!0}async function removeblock(linkId){let data=await storage_default.get(),links=bundleLinks(data),target=data[linkId];document.getElementById(linkId)?.classList.add("removed"),delete data[linkId],links.filter(l=>l._id!==linkId).forEach(l=>{data[l._id]={...l,order:l.order-(l.order>target.order?1:0)}}),storage_default.clear(),storage_default.set(data),setTimeout(()=>{document.getElementById(linkId)?.remove()},600)}async function linkSubmission(type,importList){let data=await storage_default.get(),links=bundleLinks(data),newLinksList=[],validator=(title,url,order)=>{let startsWithEither=strs=>strs.some(str=>url.startsWith(str));url=stringMaxSize(url,512);let isConfig=startsWithEither(["about:","chrome://","edge://"]),noProtocol=!startsWithEither(["https://","http://"]),isLocalhost=url.startsWith("localhost");return url=(isConfig?"#":isLocalhost?"http://":noProtocol?"https://":"")+url,{order,_id:"links"+randomString(6),title:stringMaxSize(title,64),icon:"src/assets/interface/loading.svg",url}};if(type==="add"){let titledom=document.getElementById("i_title"),urldom=document.getElementById("i_url"),title=titledom.value,url=urldom.value;if(url.length<3)return;titledom.value="",urldom.value="",newLinksList.push(validator(title,url,links.length))}if(type==="import"&&importList){if(importList?.length===0)return;importList.forEach(({title,url},i)=>{url!=="false"&&newLinksList.push(validator(title,url,links.length+i))})}newLinksList.forEach(newlink=>{storage_default.set({[newlink._id]:newlink})}),links.push(...newLinksList),initblocks(links,data.linknewtab),domlinkblocks.style.visibility="visible"}function textOnlyControl(block,title,toText){let span=block.querySelector("span"),a=block.querySelector("a");if(span&&a){let origin="";try{origin=new URL(a.href)?.origin}catch{console.warn("Cannot get origin of URL"),origin=title}span.textContent=toText&&title===""?origin:title}}function setRows(amount,style){let sizes={large:{width:4.8,gap:2.3},medium:{width:3.5,gap:2},small:{width:2.5,gap:2},text:{width:5,gap:2}},{width,gap}=sizes[style];domlinkblocks.style.maxWidth=(width+gap)*amount+"em"}function handleSafariNewtab(e){let anchor=e.composedPath().filter(el=>el.tagName==="A")[0];window.open(anchor?.href),e.preventDefault()}async function linksUpdate({bookmarks,newtab,style,row,add}){if(add&&linkSubmission("add"),bookmarks&&linkSubmission("import",bookmarks),newtab!==void 0&&(storage_default.set({linknewtab:newtab}),document.querySelectorAll(".block a").forEach(a=>{if(getBrowser()==="safari"){newtab?a.addEventListener("click",handleSafariNewtab):a.removeEventListener("click",handleSafariNewtab);return}newtab?a.setAttribute("target","_blank"):a.removeAttribute("target")})),style){let data=await storage_default.get(),links=bundleLinks(data),classes=["large","medium","small","text"],blocks=document.querySelectorAll("#linkblocks .block"),chosenClass=style??"large";links.forEach(({title},i)=>textOnlyControl(blocks[i],title,chosenClass==="text")),classes.forEach(c=>domlinkblocks.classList.remove(c)),domlinkblocks.classList.add(chosenClass),setRows(data.linksrow,chosenClass),storage_default.set({linkstyle:chosenClass})}if(row){let domStyle=domlinkblocks.className||"large",val=parseInt(row??"6");setRows(val,domStyle),eventDebounce({linksrow:row})}}async function quickLinks(init,event){if(event){linksUpdate(event);return}if(!init){errorMessage("No data for quick links !");return}if(domlinkblocks.className=init.linkstyle,domlinkblocks.classList.toggle("hidden",!init.quicklinks),initblocks(bundleLinks(init),init.linknewtab),setRows(init.linksrow,init.linkstyle),setTimeout(()=>editEvents(),150),testOS.ios||!mobilecheck()){let domeditlink=document.getElementById("editlink");window.addEventListener("resize",()=>{domeditlink?.classList.contains("shown")&&closeEditLink()})}}async function linksImport(){let container=document.getElementById("bookmarks_container"),closeBtn=document.getElementById("bmk_close"),closeBookmarks=()=>{container.classList.toggle("hiding",!0),setTimeout(()=>container.removeAttribute("class"),400)};function main(links,bookmarks){let listdom=document.createElement("ol"),bookmarksList=[],selectedList=[];bookmarks[0].children?.forEach(cat=>{let list=cat.children;Array.isArray(list)&&bookmarksList.push(...list)});function selectBookmark(elem){let applyBtn=document.getElementById("bmk_apply"),isSelected=elem.classList.toggle("selected"),index=elem.getAttribute("data-index"),counter=listdom.querySelectorAll("li.selected").length;index&&(isSelected?selectedList.push(index):selectedList.pop(),counter===0&&(applyBtn.textContent=tradThis("Select bookmarks to import")),counter===1&&(applyBtn.textContent=tradThis("Import this bookmark")),counter>1&&(applyBtn.textContent=tradThis("Import these bookmarks")),applyBtn.classList.toggle("none",counter===0))}bookmarksList.forEach((mark,index)=>{let elem=document.createElement("li"),titleWrap=document.createElement("p"),title=document.createElement("span"),favicon2=document.createElement("img"),url=document.createElement("pre"),hostname=mark.url;if(!(!mark.url||mark.url==="")){try{hostname=new URL(mark.url).hostname}catch{}favicon2.src="https://icons.duckduckgo.com/ip3/"+hostname+".ico",favicon2.alt="",title.textContent=mark.title,url.textContent=mark.url,titleWrap.appendChild(favicon2),titleWrap.appendChild(title),elem.setAttribute("data-index",index.toString()),elem.setAttribute("tabindex","0"),elem.appendChild(titleWrap),elem.appendChild(url),elem.onclick=()=>selectBookmark(elem),elem.onkeydown=e=>e.code==="Enter"?selectBookmark(elem):"",links.filter(x=>x.url===stringMaxSize(mark.url,512)).length===0&&listdom.appendChild(elem)}});let oldList=document.querySelector("#bookmarks ol");if(oldList&&oldList.remove(),document.getElementById("bookmarks").prepend(listdom),bookmarksList.length===0){document.getElementById("bookmarks")?.classList.toggle("noneFound",!0);return}document.getElementById("bmk_apply").onclick=function(){let bookmarkToApply=selectedList.map(i=>({title:bookmarksList[parseInt(i)].title,url:bookmarksList[parseInt(i)].url||""}));bookmarkToApply.length>0&&(closeBookmarks(),quickLinks(null,{bookmarks:bookmarkToApply}))},document.querySelector("#bookmarks ol li").focus()}chrome.permissions.request({permissions:["bookmarks"]},async granted=>{if(!granted)return;let data=await storage_default.get();(window.location.protocol==="moz-extension:"?browser:chrome).bookmarks.getTree().then(response=>{document.getElementById("bookmarks_container")?.classList.toggle("shown",!0),main(bundleLinks(data),response)})}),closeBtn.addEventListener("click",closeBookmarks),container.addEventListener("click",function(e){e.target.id==="bookmarks_container"&&closeBookmarks()})}async function hideElements(hidelist={},options){function applyHide(list){Object.entries(list).forEach(([key,val])=>{document.querySelector(`[data-hide="${key}"]`)?.classList.toggle("he_hidden",val)})}if(options?.isEvent){let{hide}=await storage_default.get("hide");Array.isArray(hide)&&hide.length===4&&(hide=convertHideStorage(hide)),hide={...hide,...hidelist},storage_default.set({hide}),applyHide(hidelist);return}applyHide(hidelist)}var smallWidth=!1,dominterface2=document.querySelector("#interface"),elements={time:document.getElementById("time"),main:document.getElementById("main"),quicklinks:document.getElementById("linkblocks"),searchbar:document.getElementById("sb_container"),notes:document.getElementById("notes_container"),quotes:document.getElementById("quotes_container")},activeID,isEditing=()=>dominterface2?.classList.contains("move-edit")||!1;function widgetsListToData(list,data){let states={};return"time"in list&&(states.time=list.time),"main"in list&&(states.main=list.main),"quicklinks"in list&&(states.quicklinks=list.quicklinks),"notes"in list&&(states.notes={...data.notes,on:list.notes}),"quotes"in list&&(states.quotes={...data.quotes,on:list.quotes}),"searchbar"in list&&(states.searchbar={...data.searchbar,on:list.searchbar}),states}function areaStringToLayoutGrid(area){return area.split("'").filter(a=>a.length>1).map(r=>r.split(" "))}function layoutToGridAreas(grid){let areas="",itemListToString=row=>row.reduce((a,b)=>`${a} ${b}`);return grid.forEach(row=>areas+=`'${itemListToString(row)}' `),areas}function getEnabledWidgetsFromStorage(data){let displayed={time:data.time,main:data.main,notes:!!data.notes?.on,searchbar:!!data.searchbar?.on,quicklinks:data.quicklinks,quotes:!!data.quotes?.on};return Object.entries(displayed).filter(([_,val])=>val).map(([key,_])=>key)}function getEnabledWidgetsFromGrid(grid){let flat=[...grid.flat()];return flat=flat.filter(str=>str!=="."),flat=flat.filter((str,i)=>flat.indexOf(str)===i),flat}function findIdPositions(grid,id){let allpos=[];return grid.flat().forEach((a,i)=>{a===id&&allpos.push({posCol:i%grid[0].length,posRow:Math.floor(i/grid[0].length)})}),allpos}function getSpanDirection(grid,id){let poses=findIdPositions(grid,id),rows=Object.values(poses).map(({posRow})=>posRow);return poses.length<2?"none":rows[0]!==rows[1]?"columns":"rows"}function hasDuplicateInArray(arr,id){return arr.filter(a=>a===(id||activeID)).length>1}function isRowEmpty(grid,index){if(grid[index]===void 0)return!1;let row=grid[index],empty=!0;return row.forEach(cell=>{cell!=="."&&getSpanDirection(grid,cell)!=="columns"&&(empty=!1)}),empty}function spansInGridArea(grid,id,{toggle,remove}){function addSpans(arr){let target=arr.indexOf(id),stopper=[!1,!1];function replaceWithId(a,i,lim){return!stopper[lim]&&a[i]&&(a[i]==="."?a[i]=id:a[i]!==id&&(stopper[lim]=!0)),a}for(let ii=1;ii<arr.length;ii++)arr=replaceWithId(arr,target+ii,0),arr=replaceWithId(arr,target-ii,1);return arr}function removeSpans(arr){let keepfirst=!0;return arr.map(a=>{if(a===id)if(keepfirst)keepfirst=!1;else return".";return a})}let{posCol,posRow}=findIdPositions(grid,id)[0],col=grid.map(g=>g[posCol]),row=[...grid[posRow]];return remove&&(col=removeSpans(col),row=removeSpans(row)),toggle&&(toggle==="col"&&(col=hasDuplicateInArray(col)?removeSpans(col):addSpans(col)),toggle==="row"&&(row=hasDuplicateInArray(row)?removeSpans(row):addSpans(row))),grid.forEach((r,i)=>grid[i][posCol]=col[i]),grid[posRow].forEach((r,i)=>grid[posRow][i]=row[i]),grid}function gridWidget(grid,selection,id,add){function addWidget(){if(grid.length===0){if(selection==="single")return[[id]];if(selection==="double")return[[id,"."]];if(selection==="triple")return[[".",id,"."]]}let targetCol=grid[0].length===3?1:0,index=grid.length===1?1:2;id==="time"&&(index=0),id==="main"&&(index=grid[0][targetCol]==="time"?1:0),id==="quotes"&&(index=grid.length),id==="quicklinks"&&(index=grid[grid.length-1][targetCol]==="quotes"?grid.length-1:grid.length);function fillNewRow(cell,i){if(!cell||cell===".")return;let positions=findIdPositions(grid,cell);if(i===targetCol&&positions.length>1){grid=spansInGridArea(grid,cell,{remove:!0});return}getSpanDirection(grid,cell)==="columns"&&(newrow[i]=cell)}let newrow=grid[0].map(()=>"."),isLastRow=grid[index]===void 0;return grid[index-(isLastRow?1:0)].forEach((cell,i)=>fillNewRow(cell,i)),grid.splice(index,0,newrow),grid[index][targetCol]=id,grid}function removeWidget(){for(let i in grid)for(let k in grid[i])grid[i][k]===id&&(grid[i][k]=".");return grid.forEach((_,i)=>{isRowEmpty(grid,i)&&grid.splice(i,1)}),grid}return add?addWidget():removeWidget()}function setGridAreas(layout){document.documentElement.style.setProperty("--grid",layoutToGridAreas(layout.grid))}function setAlign(id,item){let elem=elements[id];if(elem)if(elem.style.placeSelf=item?.box||"",id!=="quicklinks")elem.style.textAlign=item?.text||"";else{let flex=item?.text=="left"?"flex-start":item?.text=="right"?"flex-end":"";elem.style.justifyContent=flex}}function setAllAligns(items){Object.keys(elements).forEach(key=>{let id=key;setAlign(id,items[id])})}function manageGridSpanner(selection){selection!=="single"?document.getElementById("grid-spanner-container")?.classList.add("active"):document.getElementById("grid-spanner-container")?.classList.remove("active")}var gridOverlay={add:id=>{let button=document.createElement("button");button.id="move-overlay-"+id,button.className="move-overlay",dominterface2?.appendChild(button),button.addEventListener("click",()=>{moveElements(null,{select:id})})},remove:id=>{document.querySelector("#move-overlay-"+id)?.remove()},removeAll:()=>{document.querySelectorAll(".move-overlay").forEach(d=>d.remove())}},buttonControl={layout:selection=>{document.querySelectorAll("#grid-layout button").forEach(button=>{button.classList.toggle("selected",button.dataset.layout===selection)})},grid:id=>{let grid=areaStringToLayoutGrid(document.documentElement?.style.getPropertyValue("--grid")||"");if(grid.length===0)return;let top=!1,bottom=!1,left=!1,right=!1,positions=findIdPositions(grid,id),widgetBottomLimit=getEnabledWidgetsFromGrid(grid).length-1,rightLimit=grid[0].length-1;positions.forEach(pos=>{if(pos.posRow===0&&(top=!0),pos.posCol===0&&(left=!0),pos.posCol===rightLimit&&(right=!0),pos.posRow===widgetBottomLimit&&(bottom=!0),pos.posRow===grid.length-1){let idOnlyRow=grid.at(pos.posRow)?.filter(id2=>id2!==".");new Set(idOnlyRow).size===1&&(bottom=!0)}}),document.querySelectorAll("#grid-mover button").forEach(b=>{let c=parseInt(b.dataset.col||"0"),r=parseInt(b.dataset.row||"0"),limit=!1;r===-1&&(limit=top),r===1&&(limit=bottom),c===-1&&(limit=left),c===1&&(limit=right),limit?b?.setAttribute("disabled",""):b?.removeAttribute("disabled")})},span:id=>{function applyStates(dir,state){let dirButton=document.querySelector(`#grid-span-${dir}s`),otherButton=document.querySelector(`#grid-span-${dir==="col"?"rows":"cols"}`);state?otherButton?.setAttribute("disabled",""):otherButton?.removeAttribute("disabled"),dirButton?.classList.toggle("selected",state)}let grid=areaStringToLayoutGrid(document.documentElement?.style.getPropertyValue("--grid")||"");if(grid.length===0)return;let{posCol,posRow}=findIdPositions(grid,id)[0],col=grid.map(g=>g[posCol]),row=[...grid[posRow]];applyStates("col",hasDuplicateInArray(col,id)),applyStates("row",hasDuplicateInArray(row,id))},align:item=>{let boxBtns=document.querySelectorAll("#box-alignment-mover button"),textBtns=document.querySelectorAll("#text-alignment-mover button");boxBtns.forEach(b=>b.classList.toggle("selected",b.dataset.align===(item?.box||""))),textBtns.forEach(b=>b.classList.toggle("selected",b.dataset.align===(item?.text||"")))},title:id=>{let titlestr="",editingNames={time:tradThis("Time & Date"),main:tradThis("Weather"),notes:tradThis("Notes"),searchbar:tradThis("Search bar"),quotes:tradThis("Quotes"),quicklinks:tradThis("Quick Links")};titlestr=id?editingNames[id]:tradThis("No selection"),document.getElementById("mover-title").textContent=titlestr}};function removeSelection(){activeID=null,buttonControl.align(),buttonControl.title(),document.querySelectorAll(".grid-spanner")?.forEach(elem=>{elem.removeAttribute("disabled"),elem?.classList.remove("selected")}),document.querySelectorAll(".move-overlay").forEach(elem=>{elem.classList.remove("selected")}),document.querySelectorAll("#grid-mover button").forEach(b=>{b.removeAttribute("disabled")})}function moveElements(init,events){let moverdom=document.querySelector("#element-mover"),firstPos={x:0,y:0},moverPos={x:0,y:0};async function updateMoveElement(prop){let data=await storage_default.get(),move=data.move;move||(move=structuredClone(syncDefaults.move)),smallWidth&&(move.selection="single");function gridChange(){if(!activeID)return;let y=parseInt(prop.grid?.y||"0"),x=parseInt(prop.grid?.x||"0"),grid=move.layouts[move.selection].grid,allActivePos=findIdPositions(grid,activeID),allAffectedIds=[];allActivePos.some(({posRow})=>grid[posRow+y]===void 0)&&(move.selection==="single"&&grid.push(["."]),move.selection==="double"&&grid.push([".","."]),move.selection==="triple"&&grid.push([".",".","."])),allActivePos.forEach(({posRow,posCol})=>{let newposition=grid[posRow+y][posCol+x];newposition!=="."&&allAffectedIds.push(newposition)}),allAffectedIds.forEach(id=>{findIdPositions(grid,id).length>1&&(grid=spansInGridArea(grid,id,{remove:!0}))}),allActivePos.forEach(({posRow,posCol})=>{let newRow=Math.min(Math.max(posRow+y,0),grid.length-1),newCol=Math.min(Math.max(posCol+x,0),grid[0].length-1),tempItem=grid[posRow][posCol];grid[posRow][posCol]=grid[newRow][newCol],grid[newRow][newCol]=tempItem}),grid.forEach((_,i)=>{isRowEmpty(grid,i)&&grid.splice(i,1)}),setGridAreas(move.layouts[move.selection]),move.layouts[move.selection].grid=grid,buttonControl.grid(activeID),storage_default.set({move})}function alignChange(type){if(!activeID)return;let item=move.layouts[move.selection].items[activeID]||{box:"",text:""};item[type]=prop.box||prop.text||"",setAlign(activeID,item),buttonControl.align(item),move.layouts[move.selection].items[activeID]=item,storage_default.set({move})}function layoutChange(){move.selection=prop.layout||"single";let layout=move.layouts[move.selection],widgetsInGrid=getEnabledWidgetsFromGrid(layout.grid),list={time:widgetsInGrid.includes("time"),main:widgetsInGrid.includes("main"),notes:widgetsInGrid.includes("notes"),quotes:widgetsInGrid.includes("quotes"),searchbar:widgetsInGrid.includes("searchbar"),quicklinks:widgetsInGrid.includes("quicklinks")},states=widgetsListToData(list,data);storage_default.set({...states,move}),toggleWidgetsDisplay(list),setTimeout(()=>{setAllAligns(layout.items),setGridAreas(layout),buttonControl.layout(move.selection),manageGridSpanner(move.selection),removeSelection(),dominterface2?.classList.contains("move-edit")&&(gridOverlay.removeAll(),widgetsInGrid.forEach(id=>gridOverlay.add(id))),activeID&&(buttonControl.grid(activeID),buttonControl.align(layout.items[activeID]))},200)}function layoutReset(){let layout=move.layouts[move.selection],enabled=getEnabledWidgetsFromStorage(data),grid=[];enabled.forEach(id=>{grid=gridWidget(grid,move.selection,id,!0)}),move.layouts[move.selection].grid=grid,move.layouts[move.selection].items={},removeSelection(),setGridAreas(layout),buttonControl.title(),setAllAligns({quicklinks:{box:"",text:""},main:{box:"",text:""},time:{box:"",text:""},notes:{box:"",text:""},searchbar:{box:"",text:""},quotes:{box:"",text:""}}),storage_default.set({move})}function elementSelection(){let layout=move.layouts[move.selection];if(removeSelection(),!isEditing()||!prop.select)return;let id=prop.select;buttonControl.align(layout.items[id]),buttonControl.span(id),buttonControl.grid(id),buttonControl.title(id),document.getElementById("move-overlay-"+id).classList.add("selected"),document.getElementById("element-mover")?.classList.add("active"),activeID=id}function toggleMoveStatus(){dominterface2?.classList.contains("move-edit")?gridOverlay.removeAll():(buttonControl.layout(move.selection),getEnabledWidgetsFromStorage(data).forEach(id=>gridOverlay.add(id)));let mover=document.getElementById("element-mover");mover?.classList.toggle("hidden"),mover?.classList.remove("active"),dominterface2?.classList.toggle("move-edit"),removeSelection()}function toggleGridSpans(dir){if(!activeID)return;let layout=move.layouts[move.selection];layout.grid=spansInGridArea(layout.grid,activeID,{toggle:dir}),setGridAreas(layout),buttonControl.grid(activeID),buttonControl.span(activeID),storage_default.set({move})}function toggleWidgetOnGrid(){if(!events?.widget)return;let layout={...move.layouts[move.selection]},{id,on}=events?.widget;move.layouts[move.selection].grid=gridWidget(layout.grid,move.selection,id,on),removeSelection(),setGridAreas(move.layouts[move.selection]),setAllAligns(move.layouts[move.selection].items),isEditing()&&(on?gridOverlay.add(id):gridOverlay.remove(id));let list={};list[id]=on;let states=widgetsListToData(list,data);storage_default.set({...states,move})}function pageWidthOverlay(overlay){let isEditing2=document.getElementById("interface")?.classList?.contains("move-edit"),hasOverlays=document.querySelector(".move-overlay");if(!isEditing2&&overlay===!1){gridOverlay.removeAll();return}if(!hasOverlays){let grid=move.layouts[move.selection].grid;getEnabledWidgetsFromGrid(grid).forEach(id=>{gridOverlay.add(id)})}}switch(Object.keys(prop)[0]){case"toggle":toggleMoveStatus();break;case"select":elementSelection();break;case"grid":gridChange();break;case"span":toggleGridSpans(prop.span);break;case"box":alignChange("box");break;case"text":alignChange("text");break;case"layout":layoutChange();break;case"reset":layoutReset();case"widget":toggleWidgetOnGrid();break;case"overlay":pageWidthOverlay(prop.overlay);break}}function moverToolboxEvents(){function moverDrag(e){let pos=e.touches?e.touches[0]:e,x=pos.clientX,y=pos.clientY;if(firstPos.x===0&&firstPos.y===0){firstPos={x:x-moverPos.x,y:y-moverPos.y};return}moverPos={x:x-firstPos.x,y:y-firstPos.y},moverdom&&(moverdom.style.transform=`translate(${moverPos.x}px, ${moverPos.y}px)`,moverdom.style.cursor="grabbing")}Object.entries(elements).forEach(([key,elem])=>{elem?.addEventListener("click",()=>updateMoveElement({select:key}))}),document.querySelectorAll("#grid-mover button").forEach(btn=>{btn.addEventListener("click",()=>updateMoveElement({grid:{x:btn.dataset.col,y:btn.dataset.row}}))}),document.querySelectorAll("#box-alignment-mover button").forEach(btn=>{btn.addEventListener("click",()=>updateMoveElement({box:btn.dataset.align}))}),document.querySelectorAll("#text-alignment-mover button").forEach(btn=>{btn.addEventListener("click",()=>updateMoveElement({text:btn.dataset.align}))}),document.querySelector("#close-mover")?.addEventListener("click",()=>{updateMoveElement({toggle:!0})}),document.querySelector("#grid-span-cols")?.addEventListener("click",()=>{updateMoveElement({span:"col"})}),document.querySelector("#grid-span-rows")?.addEventListener("click",()=>{updateMoveElement({span:"row"})}),moverdom?.addEventListener("mousedown",e=>{e.target?.id==="element-mover"&&moverdom?.addEventListener("mousemove",moverDrag)}),moverdom?.addEventListener("touchstart",e=>{e.target?.id==="element-mover"&&moverdom?.addEventListener("touchmove",moverDrag)},{passive:!1});let removeDrag=()=>{firstPos={x:0,y:0},moverdom.style.removeProperty("cursor"),moverdom?.removeEventListener("mousemove",moverDrag),moverdom?.removeEventListener("touchmove",moverDrag)};moverdom?.addEventListener("mouseup",removeDrag),moverdom?.addEventListener("mouseleave",removeDrag),moverdom?.addEventListener("touchend",removeDrag)}if(events){typeof events.overlay=="boolean"&&updateMoveElement({overlay:events.overlay}),events?.widget&&updateMoveElement({widget:events.widget}),events?.select&&updateMoveElement({select:events.select}),events?.layout&&updateMoveElement({layout:events.layout}),events?.toggle&&updateMoveElement({toggle:!0}),events?.reset&&updateMoveElement({reset:!0});return}if(setTimeout(()=>moverToolboxEvents(),200),!init&&!events){updateMoveElement({reset:!0});return}if(init){let layout=init.layouts[init.selection];manageGridSpanner(init.selection),setAllAligns(layout.items),setGridAreas(layout)}}var allCollectionType={noon:"GD4aOSg4yQE",day:"o8uX55RbBPs",evening:"3M2rKTckZaQ",night:"bHDh4Ae7O8o",user:""};function getCache(){return parse(localStorage.unsplashCache)??{...localDefaults.unsplashCache}}async function preloadImage(src){let img=new Image;sessionStorage.setItem("waitingForPreload","true");try{img.src=src,await img.decode(),img.remove(),sessionStorage.removeItem("waitingForPreload")}catch{console.warn("Could not decode image: ",src)}}function imgCredits(image){let domcredit=document.getElementById("credit"),needsSpacer=!1,artist="",photoLocation="",exifDescription="",referral="?utm_source=Bonjourr&utm_medium=referral",{city,country,name,username,link,exif}=image;!city&&!country?photoLocation=tradThis("Photo by "):(city&&(photoLocation=city+", "),country&&(photoLocation+=country,needsSpacer=!0)),exif&&[{key:"model",format:"%val% - "},{key:"aperture",format:"f/%val% "},{key:"exposure_time",format:"%val%s "},{key:"iso",format:"ISO %val% "},{key:"focal_length",format:"%val%mm"}].forEach(({key,format})=>{if(Object.keys(exif).includes(key)){let exifVal=exif[key];exifVal&&(exifDescription+=key==="iso"?exifVal.toString():format.replace("%val%",exifVal.toString()))}}),artist=name.split(" ").map(s=>s.charAt(0).toUpperCase()+s.slice(1).toLocaleLowerCase()).join(" ");let locationDOM=document.createElement("a"),spacerDOM=document.createElement("span"),artistDOM=document.createElement("a"),exifDOM=document.createElement("p");exifDOM.className="exif",exifDOM.textContent=exifDescription,locationDOM.textContent=photoLocation,artistDOM.textContent=artist,spacerDOM.textContent=" - ",locationDOM.href=link+referral,artistDOM.href="https://unsplash.com/@"+username+referral,domcredit&&(domcredit.textContent="",domcredit.appendChild(exifDOM),domcredit.appendChild(locationDOM),needsSpacer&&domcredit.appendChild(spacerDOM),domcredit.appendChild(artistDOM),document.getElementById("creditContainer")?.classList.toggle("shown",!0))}function loadBackground(props){imgBackground(props.url,props.color),imgCredits(props)}function chooseCollection(customCollection){return customCollection?(customCollection=customCollection.replaceAll(" ",""),allCollectionType.user=customCollection,"user"):periodOfDay(sunTime())}function collectionUpdater(unsplash){let{every,lastCollec,collection}=unsplash;if((every==="pause"||every==="day")&&lastCollec)return lastCollec;let collec=chooseCollection(collection);return unsplash.lastCollec=collec,collec!==lastCollec&&storage_default.set({unsplash},()=>console.warn("bad")),collec}async function requestNewList(collecType){let header=new Headers,url=`https://api.unsplash.com/photos/random?collections=${allCollectionType[collecType]||allCollectionType.day}&count=8`;header.append("Authorization",`Client-ID ${atob("MzY4NmMxMjIyMWQyOWNhOGY3OTQ3Yzk0NTQyMDI1ZDc2MGE4ZTBkNDkwMDdlYzcwZmEyYzRiOWY5ZDM3N2IxZA==")}`),header.append("Accept-Version","v1");let resp,json;if(resp=await fetch(url,{headers:header}),resp.status===404)return collecType==="user"?await requestNewList(chooseCollection()||"day"):[];if(json=await resp.json(),json.length===1)return await requestNewList(chooseCollection()||"day");let filteredList=[],{width,height}=screen,dpr=window.devicePixelRatio,quality=Math.min(100-dpr*20,75);return json.forEach(img=>{filteredList.push({url:`${img.urls.raw}&w=${width}&h=${height}&dpr=${dpr}&auto=format&q=${quality}&fit=crop`,link:img.links.html,username:img.user.username,name:img.user.name,city:img.location.city,country:img.location.country,color:img.color,exif:img.exif,desc:img.description})}),filteredList}async function cacheControl(unsplash,collecType){let needNewImage=freqControl.get(unsplash.every,unsplash.time),cache=getCache(),list=cache[collecType];if(cache[collecType].length===0){if(list=await requestNewList(collecType),!list)return;await preloadImage(list[0].url),cache[collecType]=list,localStorage.setItem("unsplashCache",JSON.stringify(cache)),sessionStorage.setItem("waitingForPreload","true")}if(sessionStorage.waitingForPreload==="true"){loadBackground(list[0]),await preloadImage(list[1].url);return}if(!needNewImage){loadBackground(list[0]);return}if(unsplash.lastCollec=collecType,unsplash.time=freqControl.set(),list.length>1&&list.shift(),loadBackground(list[0]),list.length===1&&navigator.onLine){let newList=await requestNewList(collecType);if(!newList)return;cache[collecType]=list.concat(newList),await preloadImage(newList[0].url),localStorage.setItem("unsplashCache",JSON.stringify(cache));return}else list.length>1&&await preloadImage(list[1].url);storage_default.set({unsplash}),localStorage.setItem("unsplashCache",JSON.stringify(cache))}async function updateUnsplash({refresh,every,collection}){let{unsplash}=await storage_default.get("unsplash"),unsplashCache=getCache();if(unsplash){if(refresh){if(sessionStorage.waitingForPreload){turnRefreshButton(refresh,!1);return}unsplash.time=0,storage_default.set({unsplash}),turnRefreshButton(refresh,!0),setTimeout(()=>cacheControl(unsplash,collectionUpdater(unsplash)),400)}if(every!==void 0){if(!every||!every.match(/tabs|hour|day|period|pause/g))return console.log('Not valid "every" value');unsplash.every=every,unsplash.time=freqControl.set(),storage_default.set({unsplash})}if(collection!==void 0){if(!navigator.onLine||typeof collection!="string")return;if(collection===""){let defaultColl=chooseCollection();unsplashCache.user=[],unsplash.collection="",unsplash.lastCollec=defaultColl,storage_default.set({unsplash}),localStorage.setItem("unsplashCache",JSON.stringify(unsplashCache)),unsplashBackgrounds(unsplash);return}unsplash.collection=collection,unsplash.lastCollec="user",unsplash.time=freqControl.set(),storage_default.set({unsplash}),cacheControl(unsplashCache,chooseCollection(collection))}}}async function unsplashBackgrounds(init,event){if(event&&updateUnsplash(event),init)try{cacheControl(init,collectionUpdater(init))}catch(e){errorMessage(e)}}function promisifyRequest(request){return new Promise((resolve,reject)=>{request.oncomplete=request.onsuccess=()=>resolve(request.result),request.onabort=request.onerror=()=>reject(request.error)})}function createStore(dbName,storeName){let request=indexedDB.open(dbName);request.onupgradeneeded=()=>request.result.createObjectStore(storeName);let dbp=promisifyRequest(request);return(txMode,callback)=>dbp.then(db=>callback(db.transaction(storeName,txMode).objectStore(storeName)))}var defaultGetStoreFunc;function defaultGetStore(){return defaultGetStoreFunc||(defaultGetStoreFunc=createStore("keyval-store","keyval")),defaultGetStoreFunc}function get(key,customStore=defaultGetStore()){return customStore("readonly",store=>promisifyRequest(store.get(key)))}function set(key,value,customStore=defaultGetStore()){return customStore("readwrite",store=>(store.put(value,key),promisifyRequest(store.transaction)))}function update(key,updater,customStore=defaultGetStore()){return customStore("readwrite",store=>new Promise((resolve,reject)=>{store.get(key).onsuccess=function(){try{store.put(updater(this.result),key),resolve(promisifyRequest(store.transaction))}catch(err){reject(err)}}}))}function del(key,customStore=defaultGetStore()){return customStore("readwrite",store=>(store.delete(key),promisifyRequest(store.transaction)))}var localIsLoading=!1,localImages={get:async()=>{let res=await get("localImages");return{selected:res?.selected??"",freq:res?.freq??"pause",ids:res?.ids??[],last:res?.last??0}},set:val=>{set("localImages",val)},update:val=>{update("localImages",prev=>({...prev,...val}))}};function selectThumbnail(id){document.querySelector(".thumbnail.selected")?.classList.remove("selected"),document.getElementById(id)?.classList?.add("selected")}function findNextImage(ids,selected){let filtered=ids=ids.filter(l=>!l.includes(selected)),randomId=Math.floor(Math.random()*filtered.length);return filtered[randomId]}async function getBlob(id,which){let blobs=await get(id);return blobs?blobs[which]:void 0}async function compressThumbnail(blob){let blobURL=window.URL.createObjectURL(blob),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image;return img.src=blobURL,await new Promise(resolve=>{img.onload=()=>{let height=140*window.devicePixelRatio,scaleFactor=height/img.height;canvas.width=img.width*scaleFactor,canvas.height=height,ctx?.drawImage(img,0,0,img.width*scaleFactor,height),resolve(!0)}}),await new Promise(resolve=>ctx?.canvas.toBlob(resolve,"image/webp",80))}async function dataURIsFromFiles(files){let URIs=[];for(let file of files)await new Promise(resolve=>{let reader=new FileReader;reader.onload=async function(e){typeof e.target?.result=="string"&&(URIs.push(e.target?.result),resolve(!0)),resolve(!1)},reader.readAsDataURL(file)});return URIs}async function addNewImage(dataURIs){let{ids,selected}=await localImages.get(),blobs={},newIds=[];localIsLoading=!0,ids.length===0&&storage_default.set({background_type:"local"});for(let dataURI of dataURIs){let id=randomString(8);newIds.push(id),selected=id;let blob=await(await fetch(dataURI)).blob(),thumbnail=await compressThumbnail(blob);blobs[id]={thumbnail,background:blob},addThumbnail(thumbnail,id,!1),await set(id,blobs[id])}localImages.update({ids:ids.concat(newIds),selected}),localIsLoading=!1,displayCustomBackground(blobs[selected].background),selectThumbnail(selected)}async function addThumbnail(blob,id,isSelected,settingsDom){let settings=settingsDom||document.getElementById("settings"),thb=document.createElement("button"),rem=document.createElement("button"),thbimg=document.createElement("img"),remspan=document.createElement("span"),wrap=settings?.querySelector("#fileContainer");thb.id=id,thbimg.src=URL.createObjectURL(blob),thb.className="thumbnail"+(isSelected?" selected":""),rem.classList.toggle("b_removethumb",!0),rem.classList.toggle("hidden",!mobilecheck()),thb.setAttribute("aria-label","Select this background"),rem.setAttribute("aria-label","Remove this background"),thbimg.setAttribute("alt",""),thbimg.setAttribute("draggable","false"),remspan.textContent="\u2715",rem.appendChild(remspan),thb.appendChild(thbimg),thb.appendChild(rem),wrap?.prepend(thb);async function applyThisBackground(e){if(e.button!==0||localIsLoading)return;let userImages=await localImages.get(),id2=this?.parentElement?.id;id2&&id2!==userImages.selected&&(localIsLoading=!1,localImages.update({selected:id2}),selectThumbnail(id2),displayCustomBackground(await getBlob(id2,"background")))}async function deleteThisBackground(e){if(e.button!==0||localIsLoading||!e.target)return;let{ids,selected}=await localImages.get(),thumbnail=this?.parentElement,id2=thumbnail?.id;if(id2&&(thumbnail?.classList.toggle("hiding",!0),setTimeout(()=>thumbnail?.remove(),100),ids=ids.filter(s=>!s.includes(id2)),localImages.update({ids}),del(id2)),id2===selected){if(ids.length>0){selected=ids[0],localImages.update({selected});let blob2=await getBlob(selected,"background");selectThumbnail(selected),displayCustomBackground(blob2);return}storage_default.set({background_type:"unsplash"}),localImages.update({ids:[],selected:""}),setTimeout(async()=>{document.getElementById("creditContainer")?.classList.toggle("shown",!0);let data=await storage_default.get("unsplash");unsplashBackgrounds(data.unsplash)},100)}}thbimg.addEventListener("click",applyThisBackground),rem.addEventListener("click",deleteThisBackground)}async function displayCustomThumbnails(settingsDom){let{ids,selected}=await localImages.get(),thumbsAmount=document.getElementById("fileContainer")?.childElementCount||0;ids.length>0&&thumbsAmount<ids.length&&ids.forEach(async id=>{let blob=await getBlob(id,"thumbnail");blob&&addThumbnail(blob,id,id===selected,settingsDom)})}async function displayCustomBackground(blob){blob&&(imgBackground(URL.createObjectURL(blob)),document.getElementById("creditContainer")?.classList.remove("shown"),localIsLoading=!1)}async function refreshCustom(button){localImages.update({last:0}),turnRefreshButton(button,!0),setTimeout(()=>localBackgrounds(),100)}async function convertOldBackgroundStorage(every="pause"){if(!chrome?.storage)return!1;let local=await new Promise(resolve=>chrome.storage.local.get(null,resolve)),customs=[];for(let id of local?.idsList??[])id!==local.selectedId&&(customs.push(local["custom_"+id]),chrome.storage.local.remove("custom_"+id),chrome.storage.local.remove("customThumb_"+id));if(local["custom_"+local.selectedId]&&(customs.push(local["custom_"+local.selectedId]),chrome.storage.local.remove("custom_"+local.selectedId),chrome.storage.local.remove("customThumb_"+local.selectedId)),chrome.storage.local.remove("selectedId"),chrome.storage.local.remove("idsList"),customs.length>0)return localImages.set({selected:"",ids:[],freq:every,last:Date.now()}),addNewImage(customs),!0}async function localBackgrounds(event){if(event){event?.thumbnail&&displayCustomThumbnails(event?.thumbnail),event?.refresh&&refreshCustom(event.refresh),event?.freq&&localImages.update({freq:event?.freq}),event?.newfile&&addNewImage(await dataURIsFromFiles(event.newfile));return}try{let{ids,selected,freq,last}=await localImages.get(),needNewImage=freqControl.get(freq,last)&&ids.length>1;if(ids.length===0){let data=await storage_default.get("unsplash");await convertOldBackgroundStorage()||unsplashBackgrounds(data.unsplash??null);return}needNewImage&&(selected=findNextImage(ids,selected),localImages.update({selected,last:freqControl.set()})),document.getElementById("settings")&&(document.querySelector("#i_freq").value=freq,selectThumbnail(selected)),displayCustomBackground(await getBlob(selected,"background"))}catch(e){errorMessage(e)}}function throttle(callback,waitFor){let timeout,inThrottle,lastTime;return function(...args){if(!inThrottle){callback(...args),lastTime=Date.now(),inThrottle=!0;return}clearTimeout(timeout),timeout=setTimeout(()=>{Date.now()-lastTime>=waitFor&&(lastTime=Date.now(),callback(...args))},Math.max(waitFor-(Date.now()-lastTime),0))}}var import_deepmerge=__toESM(require_cjs());function filterImports(current,toImport){if(Array.isArray(toImport.hide)&&(toImport.hide=convertHideStorage(toImport.hide),toImport.time=!(toImport.hide.clock&&toImport.hide.date),toImport.main=!(toImport.hide.weatherdesc&&toImport.hide.weathericon&&toImport.hide.weathericon)),typeof toImport.searchbar=="boolean"&&(toImport.searchbar={...syncDefaults.searchbar,on:toImport.searchbar,newtab:toImport.searchbar_newtab||!1,engine:toImport.searchbar_engine?.replace("s_","")||"google"},delete toImport.searchbar_newtab,delete toImport.searchbar_engine),Array.isArray(toImport.links)&&(toImport.links.length>0&&toImport.quicklinks===void 0&&(toImport.quicklinks=!0),toImport.links?.forEach(({title,url,icon},i)=>{let id="links"+randomString(6),filteredIcon=icon?.startsWith("alias:")?toImport[icon]:icon;toImport[id]={_id:id,order:i,title,url,icon:filteredIcon}}),delete toImport.links,Object.keys(toImport).filter(key=>key.match("alias:")).forEach(key=>delete toImport[key])),!toImport.move){let importStates={time:toImport.time??current.time,main:toImport.main??current.main,notes:toImport.notes?.on??(current.notes?.on||!1),quotes:toImport.quotes?.on??current.quotes?.on,searchbar:toImport.searchbar?.on??current.searchbar?.on,quicklinks:toImport.quicklinks??current.quicklinks},diffWidgets={time:current.time!==importStates.time,main:current.main!==importStates.main,notes:current.notes?.on!==importStates.notes,quotes:current.quotes?.on!==importStates.quotes,searchbar:current.searchbar?.on!==importStates.searchbar,quicklinks:current.quicklinks!==importStates.quicklinks};Object.keys(toImport).some(key=>key.match(/time|main|notes|quotes|searchbar|quicklinks/g))&&(current.move.selection="single");let layout=structuredClone(current.move.layouts[current.move.selection]);Object.entries(diffWidgets).filter(([_,diff])=>diff===!0).forEach(([key,_])=>{layout.grid=gridWidget(layout.grid,current.move.selection,key,importStates[key])}),current.move.layouts[current.move.selection].grid=layout.grid,current.move.layouts[current.move.selection].items=layout.items}return toImport.move&&current.move&&Object.entries(toImport.move?.layouts).forEach(([key,layout])=>{let keyIsValidLayout=key in current.move.layouts,layoutKey=key;layout.grid&&keyIsValidLayout&&(current.move.layouts[layoutKey].grid=[])}),bundleLinks(current).forEach(elem=>{delete current[elem._id]}),current=(0,import_deepmerge.default)(current,toImport),current.about={...syncDefaults.about},current}function stringifyOrder(data){let sync={...syncDefaults},orderedKeys=Object.keys(sync),keylist=new Set;JSON.stringify(data,(key,value)=>(keylist.add(key),value));let links=bundleLinks(data);links.length>0&&links.forEach(link=>orderedKeys.splice(orderedKeys.indexOf("linksrow")+1,0,link._id));let sortOrder=(a,b)=>orderedKeys.indexOf(a)-orderedKeys.indexOf(b);return JSON.stringify(data,Array.from(keylist).sort(sortOrder),2)}function initParams(data,settingsDom){if(settingsDom==null)return;let paramId=str=>settingsDom.querySelector("#"+str),paramClasses=str=>settingsDom.querySelectorAll("."+str),initCheckbox=(id,cat)=>{paramId(id).checked=cat},initInput=(id,val)=>{let input=paramId(id);input.value=typeof val=="string"?val:val.toString()},userQuotes=data.quotes?.userlist?.[0]?data.quotes?.userlist:void 0;initInput("i_blur",data.background_blur??15),initInput("i_bright",data.background_bright??.8),initInput("cssEditor",data.css||""),initInput("i_row",data.linksrow||8),initInput("i_linkstyle",data.linkstyle||"default"),initInput("i_type",data.background_type||"unsplash"),initInput("i_freq",data.unsplash?.every),initInput("i_dark",data.dark||"system"),initInput("i_favicon",data.favicon??""),initInput("i_tabtitle",data.tabtitle??""),initInput("i_pagewidth",data.pagewidth||1600),initInput("i_pagegap",data.pagegap??1),initInput("i_greeting",data.greeting??""),initInput("i_textshadow",data.textShadow??.2),initInput("i_noteswidth",data.notes?.width||50),initInput("i_notesopacity",data.notes?.opacity.toString()||.1),initInput("i_notesalign",data.notes?.align||"left"),initInput("i_sbengine",data.searchbar?.engine||"google"),initInput("i_sbplaceholder",data.searchbar?.placeholder||""),initInput("i_sbopacity",data.searchbar?.opacity??.1),initInput("i_sbrequest",data.searchbar?.request||""),initInput("i_qtfreq",data.quotes?.frequency||"day"),initInput("i_qttype",data.quotes?.type||"classic"),initInput("i_qtlist",JSON.stringify(userQuotes)??""),initInput("i_clockface",data.clock?.face||"none"),initInput("i_clockstyle",data.clock?.style||"round"),initInput("i_timezone",data.clock?.timezone||"auto"),initInput("i_collection",data.unsplash?.collection??""),initInput("i_ccode",data.weather?.ccode||"US"),initInput("i_forecast",data.weather?.forecast||"auto"),initInput("i_temp",data.weather?.temperature||"actual"),initInput("i_moreinfo",data.weather?.moreinfo||"none"),initInput("i_provider",data.weather?.provider??""),initInput("i_customfont",data.font?.family??""),initInput("i_weight",data.font?.weight||"300"),initInput("i_size",data.font?.size||(mobilecheck()?11:14)),initCheckbox("i_showall",data.showall),initCheckbox("i_settingshide",data.hide?.settingsicon??!1),initCheckbox("i_quicklinks",data.quicklinks),initCheckbox("i_linknewtab",data.linknewtab),initCheckbox("i_time",data.time),initCheckbox("i_usdate",data.usdate),initCheckbox("i_main",data.main),initCheckbox("i_geol",typeof data.weather?.location!="boolean"),initCheckbox("i_units",data.weather?.unit==="imperial"),initCheckbox("i_greethide",!data.hide?.greetings),initCheckbox("i_notes",data.notes?.on??!1),initCheckbox("i_sb",data.searchbar?.on??!1),initCheckbox("i_quotes",data.quotes?.on??!1),initCheckbox("i_ampm",data.clock?.ampm??!1),initCheckbox("i_sbnewtab",data.searchbar?.newtab??!1),initCheckbox("i_qtauthor",data.quotes?.author??!1),initCheckbox("i_seconds",data.clock?.seconds??!1),initCheckbox("i_analog",data.clock?.analog??!1),translatePlaceholders(settingsDom),mobilecheck()&&(settingsDom.querySelector(".tooltiptext .instructions").textContent=tradThis("Edit your Quick Links by long-pressing the icon."));let i_lang=paramId("i_lang");if(Object.entries(langs_default).forEach(([code,title])=>{let option=document.createElement("option");option.value=code,option.text=title,i_lang.appendChild(option)}),initInput("i_lang",data.lang||"en"),localStorage.hasUpdated==="true"){changelogControl(settingsDom);let movemoveddom=settingsDom.querySelector("#move-option-moved"),movemovedbtn=settingsDom.querySelector("#move-option-moved button");movemoveddom?.setAttribute("style","display: block"),movemovedbtn?.addEventListener("click",()=>{movemoveddom?.setAttribute("style","display: none"),localStorage.removeItem("hasUpdated")})}(detectPlatform()==="safari"||detectPlatform()==="online")&&paramId("b_importbookmarks").setAttribute("style","display: none"),paramId("time_options")?.classList.toggle("shown",data.time),paramId("main_options")?.classList.toggle("shown",data.main),paramId("weather_provider")?.classList.toggle("shown",data.weather?.moreinfo==="custom"),paramId("quicklinks_options")?.classList.toggle("shown",data.quicklinks),paramId("notes_options")?.classList.toggle("shown",data.notes?.on||!1),paramId("searchbar_options")?.classList.toggle("shown",data.searchbar?.on),paramId("searchbar_request")?.classList.toggle("shown",data.searchbar?.engine==="custom"),paramId("quotes_options")?.classList.toggle("shown",data.quotes?.on),settingsDom.querySelectorAll("#grid-layout button").forEach(b=>{let selectedLayout=b.dataset.layout===(data.move?.selection||"single");b?.classList.toggle("selected",selectedLayout)}),window.innerWidth<600&&"ontouchstart"in window&&(settingsDom.querySelector('#grid-layout button[data-layout="double"]')?.setAttribute("disabled",""),settingsDom.querySelector('#grid-layout button[data-layout="triple"]')?.setAttribute("disabled","")),function(){let{clock:clock2,date,weatherdesc,weathericon}=data.hide||{},time=!clock2&&!date?"all":clock2?"clock":"date",weather2=weatherdesc&&weathericon?"disabled":weatherdesc?"desc":weathericon?"icon":"all";initInput("i_timehide",time),initInput("i_weatherhide",weather2)}(),customFont(data.font,{initsettings:settingsDom}),paramId("local_options")?.classList.toggle("shown",data.background_type==="local"),paramId("unsplash_options")?.classList.toggle("shown",data.background_type==="unsplash"),data.background_type==="local"&&localBackgrounds({thumbnail:settingsDom});let fileContainer=settingsDom.querySelector("#fileContainer"),optionsDom=settingsDom.querySelector("#local_options");fileContainer&&new MutationObserver(()=>{let thumbsHeight=fileContainer?.offsetHeight??0;optionsDom?.style.setProperty("--thumbnails-grid-height",thumbsHeight+"px")}).observe(fileContainer,{childList:!0});let i_geol=paramId("i_geol");if(data.weather&&Object.keys(data.weather).length>0){let isGeolocation=data.weather?.location?.length>0,cityName=data.weather?.city||"City";paramId("i_city").setAttribute("placeholder",cityName),paramId("sett_city")?.classList.toggle("shown",!isGeolocation),i_geol.checked=isGeolocation}else paramId("sett_city")?.classList.toggle("shown",!0),i_geol.checked=!0;data.cssHeight&&paramId("cssEditor").setAttribute("style","height: "+data.cssHeight+"px"),paramId("quotes_options")?.classList.toggle("shown",data.quotes?.on),paramId("quotes_userlist")?.classList.toggle("shown",data.quotes?.type==="user"),updateExportJSON(settingsDom);let enterBlurs=elem=>{elem.onkeyup=e=>{e.key==="Enter"&&e.target.blur()}};if(enterBlurs(paramId("i_favicon")),enterBlurs(paramId("i_tabtitle")),enterBlurs(paramId("i_greeting")),enterBlurs(paramId("i_sbplaceholder")),paramClasses("uploadContainer").forEach(function(uploadContainer){let toggleDrag=()=>uploadContainer.classList.toggle("dragover"),input=uploadContainer.querySelector('input[type="file"');input?.addEventListener("dragenter",toggleDrag),input?.addEventListener("dragleave",toggleDrag),input?.addEventListener("drop",toggleDrag)}),mobilecheck()){let instr=settingsDom.querySelector(".tooltiptext .instructions");instr&&(instr.textContent=tradThis("Edit your Quick Links by long-pressing the icon."))}if(settingsDom.querySelectorAll(".tooltip").forEach(elem=>{elem.addEventListener("click",function(){let cl=[...elem.classList].filter(c=>c.startsWith("tt"))[0];settingsDom.querySelector(".tooltiptext."+cl)?.classList.toggle("shown")})}),mobilecheck()){let touchHandler=start=>settingsDom.style.opacity=start?"0.2":"1";settingsDom.querySelectorAll("input[type='range'").forEach(input=>{input.addEventListener("touchstart",()=>touchHandler(!0),{passive:!0}),input.addEventListener("touchend",()=>touchHandler(!1),{passive:!0})})}paramId("i_showall").addEventListener("change",function(){showall(this.checked,!0)}),paramId("i_lang").addEventListener("change",function(){switchLangs(this.value)}),paramId("i_favicon").addEventListener("input",function(){favicon(this.value,!0)}),paramId("i_tabtitle").addEventListener("input",function(){tabTitle(this.value,!0)}),paramId("i_dark").addEventListener("change",function(){darkmode(this.value,!0)}),paramId("b_editmove").addEventListener("click",function(){moveElements(null,{toggle:!0})}),paramId("b_resetlayout").addEventListener("click",function(){moveElements(null,{reset:!0})}),paramId("grid-layout").querySelectorAll("button").forEach(btn=>{btn.addEventListener("click",()=>{moveElements(null,{layout:btn.dataset.layout||""})})}),paramId("i_settingshide").addEventListener("change",function(){hideElements({settingsicon:this.checked},{isEvent:!0})}),paramId("i_pagewidth").addEventListener("input",function(){pageControl({width:parseInt(this.value)},!0)}),paramId("i_pagegap").addEventListener("input",function(){pageControl({gap:parseFloat(this.value)},!0)}),paramId("i_pagewidth").addEventListener("touchstart",()=>moveElements(null,{overlay:!0}),{passive:!0}),paramId("i_pagewidth").addEventListener("mousedown",()=>moveElements(null,{overlay:!0})),paramId("i_pagewidth").addEventListener("touchend",()=>moveElements(null,{overlay:!1})),paramId("i_pagewidth").addEventListener("mouseup",()=>moveElements(null,{overlay:!1})),paramId("i_quicklinks").addEventListener("click",function(){toggleWidgetsDisplay({quicklinks:this.checked},!0)});let submitLinkFunc=throttle(()=>quickLinks(null,{add:!0}),1200);paramId("i_title").onkeyup=e=>{e.code==="Enter"&&submitLinkFunc()},paramId("i_url").onkeyup=e=>{e.code==="Enter"&&submitLinkFunc()},paramId("submitlink").addEventListener("click",e=>{submitLinkFunc(),inputThrottle(e.target,1200)}),paramId("i_linknewtab").onchange=e=>{let input=e.currentTarget;quickLinks(null,{newtab:input.checked})},paramId("i_linkstyle").onchange=e=>{let input=e.currentTarget;quickLinks(null,{style:input.value})},paramId("i_row").oninput=function(e){let input=e.currentTarget;quickLinks(null,{row:input.value})},paramId("b_importbookmarks").onclick=linksImport,paramId("i_type").addEventListener("change",function(){selectBackgroundType(this.value)}),paramId("i_freq").addEventListener("change",function(){paramId("i_type").value==="local"?localBackgrounds({freq:this.value}):unsplashBackgrounds(null,{every:this.value})}),paramId("i_refresh").addEventListener("click",function(){let i_type=paramId("i_type");if(this.children[0]){let arrow=this.children[0];i_type.value==="local"?localBackgrounds({refresh:arrow}):unsplashBackgrounds(null,{refresh:arrow})}inputThrottle(this)}),paramId("i_collection").addEventListener("change",function(){unsplashBackgrounds(null,{collection:stringMaxSize(this.value,256)}),this.blur()}),paramId("i_bgfile").addEventListener("change",function(){localBackgrounds({newfile:this.files})}),paramId("i_blur").addEventListener("input",function(){backgroundFilter({blur:parseFloat(this.value),isEvent:!0})}),paramId("i_bright").addEventListener("input",function(){backgroundFilter({brightness:parseFloat(this.value),isEvent:!0})}),paramId("i_time").addEventListener("change",function(){toggleWidgetsDisplay({time:this.checked},!0)}),paramId("i_analog").addEventListener("change",function(){clock(null,{analog:this.checked})}),paramId("i_seconds").addEventListener("change",function(){clock(null,{seconds:this.checked})}),paramId("i_clockface").addEventListener("change",function(){clock(null,{face:this.value})}),paramId("i_clockstyle").addEventListener("change",function(){clock(null,{style:this.value})}),paramId("i_ampm").addEventListener("change",function(){clock(null,{ampm:this.checked})}),paramId("i_timezone").addEventListener("change",function(){clock(null,{timezone:this.value})}),paramId("i_usdate").addEventListener("change",function(){clock(null,{usdate:this.checked})}),paramId("i_timehide").addEventListener("change",function(){hideElements({clock:this.value==="clock",date:this.value==="date"},{isEvent:!0})});let weatherDebounce=debounce(()=>weather(null,{is:"city"}),1600);paramId("i_city").onkeyup=e=>{weatherDebounce(),e.code==="Enter"&&(weather(null,{is:"city"}),weatherDebounce.cancel())},paramId("i_main").addEventListener("change",function(){toggleWidgetsDisplay({main:this.checked},!0)}),paramId("i_geol").addEventListener("change",function(){inputThrottle(this,1200),weather(null,{is:"geol",checked:this.checked,elem:this})}),paramId("i_units").addEventListener("change",function(){inputThrottle(this,1200),weather(null,{is:"units",checked:this.checked})}),paramId("i_forecast").addEventListener("change",function(){weather(null,{is:"forecast",value:this.value})}),paramId("i_temp").addEventListener("change",function(){weather(null,{is:"temp",value:this.value})}),paramId("i_moreinfo").addEventListener("change",function(){weather(null,{is:"moreinfo",value:this.value})}),paramId("i_provider").addEventListener("change",function(){weather(null,{is:"provider",value:this.value}),this.blur()}),paramId("i_weatherhide").addEventListener("change",function(){let weatherdesc=this.value==="disabled"||this.value==="desc",weathericon=this.value==="disabled"||this.value==="icon";hideElements({weatherdesc,weathericon},{isEvent:!0}),weather(null,{is:"unhide",value:this.value})}),paramId("i_greethide").addEventListener("change",function(){hideElements({greetings:!this.checked},{isEvent:!0})}),paramId("i_greeting").addEventListener("keyup",function(){clock(null,{greeting:stringMaxSize(this.value,32)})}),paramId("i_notes").addEventListener("click",function(){toggleWidgetsDisplay({notes:this.checked},!0)}),paramId("i_notesalign").addEventListener("change",function(){notes(null,{is:"align",value:this.value})}),paramId("i_noteswidth").addEventListener("input",function(){notes(null,{is:"width",value:this.value})}),paramId("i_notesopacity").addEventListener("input",function(){notes(null,{is:"opacity",value:this.value})}),paramId("i_sb").addEventListener("click",function(){toggleWidgetsDisplay({searchbar:this.checked},!0)}),paramId("i_sbengine").addEventListener("change",function(){searchbar(null,{engine:this.value})}),paramId("i_sbopacity").addEventListener("input",function(){searchbar(null,{opacity:this.value})}),paramId("i_sbrequest").addEventListener("change",function(){searchbar(null,{request:this})}),paramId("i_sbnewtab").addEventListener("change",function(){searchbar(null,{newtab:this.checked})}),paramId("i_sbplaceholder").addEventListener("keyup",function(){searchbar(null,{placeholder:this.value})}),paramId("i_quotes").addEventListener("click",function(){toggleWidgetsDisplay({quotes:this.checked},!0)}),paramId("i_qtfreq").addEventListener("change",function(){quotes(null,{frequency:this.value})}),paramId("i_qttype").addEventListener("change",function(){quotes(null,{type:this.value})}),paramId("i_qtrefresh").addEventListener("click",function(){inputThrottle(this),turnRefreshButton(this.children[0],!0),quotes(null,{refresh:!0})}),paramId("i_qtauthor").addEventListener("change",function(){quotes(null,{author:this.checked})}),paramId("i_qtlist").addEventListener("change",function(){quotes(null,{userlist:this.value})}),paramId("i_customfont").addEventListener("focus",function(){settingsDom.querySelector("#dl_fontfamily")?.childElementCount===0&&customFont(null,{autocomplete:settingsDom})}),paramId("i_customfont").addEventListener("change",function(){customFont(null,{family:this.value})}),paramId("i_weight").addEventListener("input",function(){customFont(null,{weight:this.value})}),paramId("i_size").addEventListener("input",function(){customFont(null,{size:this.value})}),paramId("i_textshadow").addEventListener("input",function(){textShadow(null,parseFloat(this.value))}),paramId("cssEditor").addEventListener("keyup",function(ev){customCss(null,{is:"styling",val:ev.target.value})}),cssInputSize(paramId("cssEditor"));let{exportAsFile,copyImportText,importAsText,importAsFile}=settingsMgmt(),toggleSettingsMgmt=toggled=>{paramId("export")?.classList.toggle("shown",!toggled),paramId("import")?.classList.toggle("shown",toggled),paramClasses("tabs")[0]?.classList.toggle("toggled",toggled)};paramId("s_export").addEventListener("click",()=>toggleSettingsMgmt(!1)),paramId("s_import").addEventListener("click",()=>toggleSettingsMgmt(!0)),paramId("b_exportfile").addEventListener("click",()=>exportAsFile()),paramId("b_exportcopy").addEventListener("click",e=>copyImportText(e.target)),paramId("i_importfile").addEventListener("change",e=>importAsFile(e.target)),paramId("i_importtext").addEventListener("keyup",e=>importAsText(e.target.value)),paramId("b_resetconf").addEventListener("click",()=>paramsReset("conf")),paramId("b_resetyes").addEventListener("click",()=>paramsReset("yes")),paramId("b_resetno").addEventListener("click",()=>paramsReset("no")),paramId("b_importtext").addEventListener("click",function(){paramsImport(parse(document.getElementById("i_importtext").value))});function optionsTabIndex(){let isAllSettings=paramId("i_showall").checked,toggleTabindex=(parent,on)=>{settingsDom?.querySelectorAll(`${parent} :is(input,  select,  button,  a, textarea)`).forEach(dom=>{on?dom.removeAttribute("tabindex"):dom.setAttribute("tabindex","-1")})};isAllSettings&&toggleTabindex(".as",!0),settingsDom.querySelectorAll(".dropdown").forEach(dom=>{toggleTabindex("#"+dom.id,dom?.classList.contains("shown"))}),isAllSettings===!1&&toggleTabindex(".as",!1),settingsDom.querySelectorAll(".tooltiptext").forEach(dom=>{toggleTabindex("."+dom.classList[1],dom?.classList.contains("shown"))}),toggleTabindex("#searchbar_request",paramId("searchbar_request").classList.contains("shown")),toggleTabindex("#weather_provider",paramId("weather_provider").classList.contains("shown")),toggleTabindex("#quotes_userlist",paramId("quotes_userlist").classList.contains("shown")),toggleTabindex("#import",paramId("import").classList.contains("shown")),toggleTabindex("#export",paramId("export").classList.contains("shown")),toggleTabindex("#sett_city",paramId("i_geol").checked===!1),paramId("downloadfile").setAttribute("tabindex","-1")}optionsTabIndex(),settingsDom.querySelectorAll(".opt-hider").forEach(dom=>{dom.addEventListener("input",()=>setTimeout(()=>optionsTabIndex(),10))})}function settingsMgmt(){async function copyImportText(target){try{let area=document.getElementById("area_export");await navigator.clipboard.writeText(area.value),target.textContent=tradThis("Copied"),setTimeout(()=>{let domimport=document.getElementById("b_exportcopy");domimport&&(domimport.textContent=tradThis("Copy text"))},1e3)}catch(err){console.error("Failed to copy: ",err)}}async function exportAsFile(){let a=document.getElementById("downloadfile");if(!a)return;let data=await storage_default.get()??{},zero=n=>n.toString().length===1?"0"+n:n.toString(),bytes=new TextEncoder().encode(stringifyOrder(data)),blob=new Blob([bytes],{type:"application/json;charset=utf-8"}),date=new Date,YYYYMMDD=date.toISOString().slice(0,10),HHMMSS=`${zero(date.getHours())}_${zero(date.getMinutes())}_${zero(date.getSeconds())}`;a.setAttribute("href",URL.createObjectURL(blob)),a.setAttribute("download",`bonjourr-${data?.about?.version} ${YYYYMMDD} ${HHMMSS}.json`),a.click()}function importAsText(string){let importtext=document.getElementById("b_importtext");try{parse(string),importtext?.removeAttribute("disabled")}catch{importtext?.setAttribute("disabled","")}}function importAsFile(target){function decodeExportFile(str){let result={};try{result=parse(atob(str))}catch{try{result=parse(str)}catch{result={}}}return result}if(!target.files||target.files&&target.files.length===0)return;let file=target.files[0],reader=new FileReader;reader.onload=()=>{if(typeof reader.result!="string")return!1;let importData=decodeExportFile(reader.result);Object.keys(syncDefaults).filter(key=>key in importData).length>0&&paramsImport(importData)},reader.readAsText(file)}return{exportAsFile,copyImportText,importAsText,importAsFile}}function cssInputSize(param){setTimeout(()=>{new ResizeObserver(e=>{let rect=e[0].contentRect;customCss(null,{is:"resize",val:rect.height+rect.top*2})}).observe(param)},400)}function changelogControl(settingsDom){let domshowsettings=document.querySelector("#showSettings"),domchangelog=settingsDom.querySelector("#changelogContainer");if(!domchangelog)return;domchangelog.classList.toggle("shown",!0),domshowsettings?.classList.toggle("hasUpdated",!0);let dismiss=()=>{domshowsettings?.classList.toggle("hasUpdated",!1),domchangelog.className="dismissed",localStorage.removeItem("hasUpdated")},loglink=settingsDom.querySelector("#link"),logdismiss=settingsDom.querySelector("#log_dismiss");loglink.onclick=()=>dismiss(),logdismiss.onclick=()=>dismiss()}function translatePlaceholders(settingsDom){if(!settingsDom)return;let cases=[["#i_title","Name"],["#i_greeting","Name"],["#i_tabtitle","New tab"],["#i_sbrequest","Search query: %s"],["#i_sbplaceholder","Search"],["#cssEditor","Type in your custom CSS"],["#i_importtext","or paste as text"]];for(let[id,text]of cases)settingsDom.querySelector(id)?.setAttribute("placeholder",tradThis(text))}async function switchLangs(nextLang){await toggleTraduction(nextLang),sessionStorage.lang=nextLang,storage_default.set({lang:nextLang}),document.documentElement.setAttribute("lang",nextLang);let data=await storage_default.get()??{};data.lang=nextLang,weather(data),clock(data),quotes(data),tabTitle(data.tabtitle),notes(data.notes||null),translatePlaceholders(document.getElementById("settings"))}function showall(val,event,settingsDom){(settingsDom||document.getElementById("settings"))?.classList.toggle("all",val),event&&storage_default.set({showall:val})}async function selectBackgroundType(cat){if(document.getElementById("local_options")?.classList.toggle("shown",cat==="local"),document.getElementById("unsplash_options")?.classList.toggle("shown",cat==="unsplash"),cat==="local"&&(localBackgrounds({thumbnail:document.getElementById("settings")}),setTimeout(()=>localBackgrounds(),100)),cat==="unsplash"){let data=await storage_default.get()??{};if(!data.unsplash)return;document.querySelector("#i_freq").value=data.unsplash.every||"hour",document.getElementById("creditContainer")?.classList.toggle("shown",!0),setTimeout(()=>unsplashBackgrounds(data.unsplash),100)}storage_default.set({background_type:cat})}function signature(dom){let spans=dom.querySelectorAll("#rand span"),as=dom.querySelectorAll("#rand a"),us=[{href:"https://victr.me/",name:"Victor Azevedo"},{href:"https://tahoe.be/",name:"Tahoe Beetschen"}];Math.random()>.5&&us.reverse(),spans[0].textContent=`${tradThis("by")} `,spans[1].textContent=" & ",as.forEach((a,i)=>{a.href=us[i].href,a.textContent=us[i].name});let version=dom.querySelector(".version a");version&&(version.textContent=syncDefaults.about.version),(testOS.ios||detectPlatform()==="safari")&&dom.querySelector("#rdv_website")?.remove()}function fadeOut(){let dominterface4=document.getElementById("interface");dominterface4.click(),dominterface4.style.transition="opacity .4s",setTimeout(()=>dominterface4.style.opacity="0"),setTimeout(()=>location.reload(),400)}async function paramsImport(toImport){try{let data=await storage_default.get()??{};data={...filterImports(data,toImport)},storage_default.clear(),storage_default.set(data,()=>fadeOut())}catch(e){console.log(e)}}function paramsReset(action){if(action==="yes"){storage_default.clear(),localStorage.clear(),fadeOut();return}document.getElementById("reset_first")?.classList.toggle("shown",action==="no"),document.getElementById("reset_conf")?.classList.toggle("shown",action==="conf")}async function updateExportJSON(settingsDom){let input=settingsDom.querySelector("#area_export");settingsDom.querySelector("#importtext")?.setAttribute("disabled","");let data=await storage_default.get()??{};data?.weather?.lastCall&&delete data.weather.lastCall,data.about.browser=detectPlatform(),input.value=stringifyOrder(data)}async function settingsInit(data){let html=await(await fetch("settings.html")).text(),domshowsettings=document.getElementById("showSettings"),dominterface4=document.getElementById("interface"),domedit=document.getElementById("editlink"),parser=new DOMParser,settingsDom=document.createElement("aside"),contentList=parser.parseFromString(html,"text/html").body.childNodes;settingsDom.id="settings",settingsDom.setAttribute("class","init");for(let elem of Object.values(contentList))settingsDom.appendChild(elem);traduction(settingsDom,data.lang),signature(settingsDom),initParams(data,settingsDom),showall(data.showall,!1,settingsDom),document.body.appendChild(settingsDom);let isOnline=detectPlatform()==="online",storageUpdate=()=>updateExportJSON(settingsDom),unloadUpdate=()=>chrome.storage.onChanged.removeListener(storageUpdate);isOnline?window.addEventListener("storage",storageUpdate):(chrome.storage.onChanged.addListener(storageUpdate),window.addEventListener("beforeunload",unloadUpdate,{once:!0}));function toggleDisplay(dom){let isClosed=!dom?.classList.contains("shown");dom?.classList.toggle("init",!1),dom?.classList.toggle("shown",isClosed),domedit?.classList.toggle("pushed",isClosed),dominterface4?.classList.toggle("pushed",isClosed),domshowsettings?.classList.toggle("shown",isClosed),settingsDom.style.removeProperty("transform"),settingsDom.style.removeProperty("transition")}document.getElementById("skiptosettings")?.addEventListener("click",function(){toggleDisplay(settingsDom),settingsDom.scrollTo({top:0}),setTimeout(()=>{settingsDom.querySelector("#i_showall").focus()},10)}),domshowsettings?.addEventListener("click",function(){toggleDisplay(settingsDom)}),window.addEventListener("keydown",async function(e){if(e.altKey&&e.code==="KeyS"&&(console.clear(),console.log(localStorage),console.log(await storage_default.get())),e.code==="Escape"){document.getElementById("editlink")?.classList.contains("shown")?closeEditLink():toggleDisplay(settingsDom);return}if(e.code==="Tab"){document.body.classList.toggle("tabbing",!0);return}}),window.addEventListener("click",function(e){let path=e.composedPath()??[document.body],pathIds=e.composedPath().map(el=>el.id),areSettingsShown=settingsDom?.classList.contains("shown"),isEditlinkOpen=document.getElementById("editlink")?.classList.contains("shown"),onBody=path[0].tagName==="BODY",onInterface=pathIds.includes("interface"),onEdit=pathIds.includes("editlink");document.body.classList.contains("tabbing")&&document.body?.classList.toggle("tabbing",!1),!onEdit&&isEditlinkOpen&&closeEditLink(),(onBody||onInterface)&&areSettingsShown&&toggleDisplay(settingsDom)});function responsiveSettingsHeightDrag(){let firstPos=0,startTouchY=0;function dragStart(e){e.preventDefault(),e.type==="mousedown"&&(startTouchY=e.clientY),e.type==="touchstart"&&(startTouchY=e.touches[0].clientY),firstPos===0&&(firstPos=startTouchY),(testOS.windows||testOS.android)&&(settingsDom.style.width="calc(100% - 10px)",settingsDom.style.paddingRight="10px"),settingsDom.style.overflow="clip",window.addEventListener("touchmove",dragMove),window.addEventListener("mousemove",dragMove)}function dragMove(e){let clientY=0;e.type==="mousemove"&&(clientY=e.clientY),e.type==="touchmove"&&(clientY=e.touches[0].clientY),clientY>60&&(settingsDom.style.transform=`translateY(-${window.innerHeight+30-clientY}px)`,settingsDom.style.transition="transform .0s")}function dragEnd(e){let clientY=0;(e.type==="mouseup"||e.type==="mouseleave")&&(clientY=e.clientY),e.type==="touchend"&&(clientY=e.changedTouches[0].clientY),window.removeEventListener("touchmove",dragMove),window.removeEventListener("mousemove",dragMove),startTouchY=0,settingsDom.style.removeProperty("padding"),settingsDom.style.removeProperty("width"),settingsDom.style.removeProperty("overflow");let signaturedom=document.querySelector(".signature");signaturedom.style.paddingBottom=clientY+60+"px",clientY>window.innerHeight-100&&toggleDisplay(settingsDom)}let dragzone=settingsDom.querySelector("#mobile-drag-zone");dragzone?.addEventListener("touchstart",dragStart,{passive:!1}),dragzone?.addEventListener("mousedown",dragStart),dragzone?.addEventListener("touchend",dragEnd,{passive:!1}),dragzone?.addEventListener("mouseup",dragEnd),document.body?.addEventListener("mouseleave",e=>{settingsDom?.classList.contains("shown")&&window.innerWidth<600&&dragEnd(e)})}let DrawerDragDebounce=debounce(()=>{document.querySelector(".signature").style.removeProperty("padding"),responsiveSettingsHeightDrag()},600);window.addEventListener("resize",()=>{DrawerDragDebounce(),settingsDom.style.transition||(settingsDom.style.transition="none")}),responsiveSettingsHeightDrag()}var dominterface3=document.getElementById("interface"),functionsLoad={clock:"Waiting",links:"Waiting",fonts:"Off",quotes:"Off"},loadtimeStart=performance.now(),sunset=0,sunrise=0,freqControl={set:()=>new Date().getTime(),get:(every,last)=>{let nowDate=new Date,lastDate=new Date(last||0),changed={date:nowDate.getDate()!==lastDate.getDate(),hour:nowDate.getHours()!==lastDate.getHours()};switch(every){case"day":return changed.date;case"hour":return changed.date||changed.hour;case"tabs":return!0;case"pause":return last===0;case"period":{let sun=sunTime();return last===0||!sun?!0:periodOfDay(sun)!==periodOfDay(sun,+lastDate)||!1}default:return!1}}},interfaceFade=function(){let fadeTimeout;async function apply(duration=400){clearTimeout(fadeTimeout);let observer=new MutationObserver(()=>{fadeTimeout=setTimeout(()=>dominterface3.style.transition="",duration),dominterface3.style.removeProperty("opacity"),observer.disconnect()});observer.observe(document.documentElement,{attributes:!0}),dominterface3.style.opacity="0",dominterface3.style.transition=`opacity ${duration}ms cubic-bezier(.215,.61,.355,1)`,await new Promise(resolve=>setTimeout(resolve,duration))}return{apply}}();async function toggleWidgetsDisplay(list,fromInput){let listEntries=Object.entries(list),widgets={time:{domid:"time",inputid:"i_time"},main:{domid:"main",inputid:"i_main"},quicklinks:{domid:"linkblocks",inputid:"i_quicklinks"},notes:{domid:"notes_container",inputid:"i_notes"},quotes:{domid:"quotes_container",inputid:"i_quotes"},searchbar:{domid:"sb_container",inputid:"i_sb"}};if(listEntries.forEach(([key,on])=>{document.getElementById(key+"_options")?.classList.toggle("shown",on)}),listEntries.forEach(([key,on])=>{if(key in widgets){let id=widgets[key].inputid,input=document.getElementById(id);id&&input&&(input.checked=on)}}),await interfaceFade.apply(200),listEntries.forEach(([key,on])=>{if(key in widgets){let id=widgets[key].domid;document.getElementById(id)?.classList.toggle("hidden",!on)}}),fromInput){let[id,on]=listEntries[0];moveElements(null,{widget:{id,on}})}}function favicon(val,isEvent){function createFavicon(emoji){let svg=`data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="85">${emoji}</text></svg>`,defaulticon="/src/assets/"+(getBrowser()==="edge"?"monochrome.png":"favicon.ico");document.querySelector("head link[rel~='icon']")?.setAttribute("href",emoji?svg:defaulticon)}if(isEvent){let isEmoji=val?.match(/\p{Emoji}/gu)&&!val?.match(/[0-9a-z]/g);createFavicon(val),eventDebounce({favicon:isEmoji?val:""});return}val&&createFavicon(val)}function tabTitle(val="",isEvent){document.title=stringMaxSize(val,80)||tradThis("New tab"),isEvent&&eventDebounce({tabtitle:stringMaxSize(val,80)})}function pageControl(val,isEvent){val.width&&(document.documentElement.style.setProperty("--page-width",(val.width??syncDefaults.pagewidth)+"px"),isEvent&&eventDebounce({pagewidth:val.width})),typeof val.gap=="number"&&(document.documentElement.style.setProperty("--page-gap",(val.gap??syncDefaults.pagegap)+"em"),isEvent&&eventDebounce({pagegap:val.gap}))}function initBackground(data){let type=data.background_type||"unsplash",blur=data.background_blur,brightness=data.background_bright;backgroundFilter({blur,brightness}),type==="local"?localBackgrounds():unsplashBackgrounds(data.unsplash)}function imgBackground(url,color){let img=new Image;img.onload=()=>{let bgoverlay=document.getElementById("background_overlay"),bgfirst=document.getElementById("background"),bgsecond=document.getElementById("background-bis"),loadBis=bgfirst.style.opacity==="1",bgToChange=loadBis?bgsecond:bgfirst;bgfirst.style.opacity=loadBis?"0":"1",bgToChange.style.backgroundImage=`url(${url})`,bgoverlay.style.opacity="1",color&&testOS.ios&&(document.querySelector('meta[name="theme-color"]')?.setAttribute("content",color),setTimeout(()=>document.documentElement.style.setProperty("--average-color",color),400))},img.src=url,img.remove()}function backgroundFilter({blur,brightness,isEvent}){let hasbright=typeof brightness=="number",hasblur=typeof blur=="number";hasblur&&document.documentElement.style.setProperty("--background-blur",blur.toString()+"px"),hasbright&&document.documentElement.style.setProperty("--background-brightness",brightness.toString()),isEvent&&hasblur&&eventDebounce({background_blur:blur}),isEvent&&hasbright&&eventDebounce({background_bright:brightness})}function darkmode(value,isEvent){if(isEvent&&storage_default.set({dark:value}),value==="auto"){let{now,rise,set:set2}=sunTime(),choice=now<=rise||now>set2?"dark":"light";document.documentElement.dataset.theme=choice}value==="disable"&&(document.documentElement.dataset.theme="light"),value==="enable"&&(document.documentElement.dataset.theme="dark"),value==="system"&&(document.documentElement.dataset.theme="")}function showPopup(value){function affiche(){let popup=document.getElementById("popup"),browser2=getBrowser(),reviewURLs={chrome:"https://chrome.google.com/webstore/detail/bonjourr-%C2%B7-minimalist-lig/dlnejlppicbjfcfcedcflplfjajinajd/reviews",firefox:"https://addons.mozilla.org/en-US/firefox/addon/bonjourr-startpage/",safari:"https://apps.apple.com/fr/app/bonjourr-startpage/id1615431236",edge:"https://microsoftedge.microsoft.com/addons/detail/bonjourr/dehmmlejmefjphdeoagelkpaoolicmid",other:"https://bonjourr.fr/help#%EF%B8%8F-reviews"};function closePopup(e){e.target?.id==="popup_text"&&(popup?.classList.remove("shown"),setTimeout(()=>popup?.remove(),200),setTimeout(()=>document.getElementById("creditContainer")?.classList.add("shown"),600)),storage_default.set({reviewPopup:"removed"})}popup.style.display="flex",document.getElementById("popup_review")?.setAttribute("href",reviewURLs[browser2]),document.getElementById("popup_review")?.addEventListener("mousedown",closePopup),document.getElementById("popup_donate")?.addEventListener("mousedown",closePopup),document.getElementById("popup_text")?.addEventListener("click",closePopup,{passive:!0}),setTimeout(()=>popup?.classList.add("shown"),400),setTimeout(()=>document.getElementById("creditContainer")?.classList.remove("shown"),0)}if(typeof value=="number"){value>30?affiche():storage_default.set({reviewPopup:value+1});return}value!=="removed"&&storage_default.set({reviewPopup:0})}function textShadow(init,event){let val=init??event;document.documentElement.style.setProperty("--text-shadow-alpha",(val??.2)?.toString()),typeof event=="number"&&eventDebounce({textShadow:val})}function customCss(init,event){let styleHead=document.getElementById("styles");if(init&&(styleHead.textContent=init),event)switch(event.is){case"styling":{if(typeof event.val=="string"){let val=stringMaxSize(event.val,8080);styleHead.textContent=val,eventDebounce({css:val})}break}case"resize":{typeof event.val=="number"&&eventDebounce({cssHeight:event.val});break}}}function sunTime(init){return init&&init.lastState&&(sunrise=init.lastState.sunrise,sunset=init.lastState.sunset),sunset===0?{now:minutator(new Date),rise:420,set:1320}:{now:minutator(new Date),rise:minutator(new Date(sunrise*1e3)),set:minutator(new Date(sunset*1e3))}}function canDisplayInterface(cat,init){function displayInterface(){let loadtime=Math.min(performance.now()-loadtimeStart,400);loadtime<33&&(loadtime=0),document.documentElement.style.setProperty("--load-time-transition",loadtime+"ms"),document.body.classList.remove("loading"),setTimeout(async()=>{let data=await storage_default.get();settingsInit(data),document.body.classList.remove("init")},loadtime+100)}if(init||!cat){init?.font?.family&&init?.font?.url&&(functionsLoad.fonts="Waiting"),init?.quotes?.on&&(functionsLoad.quotes="Waiting");return}if(functionsLoad[cat]==="Off")return;functionsLoad[cat]="Ready";let noSettings=!document.getElementById("settings");Object.values(functionsLoad).includes("Waiting")===!1&&noSettings&&displayInterface()}function onlineAndMobileHandler(){if(mobilecheck()&&document.addEventListener("visibilitychange",async()=>{let data=await storage_default.get();if(!data?.clock||!data?.weather)return;let frequency=freqControl.get(data.unsplash.every,data.unsplash.time);data.background_type==="unsplash"&&frequency&&data.unsplash&&unsplashBackgrounds(data.unsplash),clock(data),weather(data),sunTime(data.weather)}),detectPlatform()==="online"){"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js");let promptEvent;if(window.addEventListener("beforeinstallprompt",function(e){return promptEvent=e,promptEvent}),getBrowser("firefox")&&mobilecheck()){let appHeight=()=>document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`);if(appHeight(),testOS.ios){let triggerAnimationFrame2=function(){appHeight(),globalID=requestAnimationFrame(triggerAnimationFrame2)};var triggerAnimationFrame=triggerAnimationFrame2;let globalID;window.requestAnimationFrame(triggerAnimationFrame2),setTimeout(()=>cancelAnimationFrame(globalID),500)}}}}function initTimeAndMainBlocks(time,main){document.getElementById("time")?.classList.toggle("hidden",!time),document.getElementById("main")?.classList.toggle("hidden",!main)}function startup(data){traduction(null,data.lang),canDisplayInterface(null,data),sunTime(data.weather),weather(data),customFont(data.font),textShadow(data.textShadow),favicon(data.favicon),tabTitle(data.tabtitle),clock(data),darkmode(data.dark),searchbar(data.searchbar),quotes(data),showPopup(data.reviewPopup),notes(data.notes||null),moveElements(data.move),customCss(data.css),hideElements(data.hide),initBackground(data),quickLinks(data),initTimeAndMainBlocks(data.time,data.main),pageControl({width:data.pagewidth,gap:data.pagegap})}(async()=>{onlineAndMobileHandler();try{let data=await storage_default.get(),version_old=data?.about?.version,version_curr=syncDefaults.about.version;if(version_old!==version_curr){if(console.log(`Version change: ${version_old} => ${version_curr}`),data.about={browser:detectPlatform(),version:version_curr},!version_old.includes("1.17")&&version_curr.includes("1.17")){localStorage.hasUpdated="true",localStorage.removeItem("translations");let getOnlineLocal=()=>JSON.parse(localStorage.bonjourrBackgrounds??"{}"),getChromeLocal=async()=>await new Promise(resolve=>chrome?.storage.local.get(null,resolve)),removeOnlineLocal=()=>localStorage.removeItem("bonjourrBackgrounds"),removeChromeLocal=()=>{chrome?.storage.local.remove("dynamicCache"),chrome?.storage.local.remove("quotesCache")},isOnline=data.about.browser==="online",local=await(isOnline?getOnlineLocal():getChromeLocal()),{unsplashCache,quotesCache}=localDefaults;localStorage.setItem("unsplashCache",JSON.stringify(local?.unsplashCache??{...unsplashCache})),localStorage.setItem("quotesCache",JSON.stringify(local?.quotesCache??quotesCache)),isOnline?removeOnlineLocal():removeChromeLocal(),data.unsplash={...data.dynamic},data.background_type==="custom"&&(data.background_type="local"),data.background_type==="dynamic"&&(data.background_type="unsplash"),delete data.dynamic,delete data.custom_every,delete data.custom_time,storage_default.remove("dynamic"),storage_default.remove("custom_every"),storage_default.remove("custom_time")}storage_default.set({...data})}await setTranslationCache(data.lang),startup(data)}catch(e){errorMessage(e)}})();})();
